<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AKRS v4 ‚Äî Knowledge System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#09090b; --s0:#0f0f11; --s1:#141418; --s2:#1a1a20; --s3:#22222a;
  --b0:#2a2a35; --b1:#35353f; --b2:#45454f;
  --t0:#fafafa; --t1:#a1a1aa; --t2:#71717a; --t3:#52525b;
  --ac:#e4ff1a; --ac2:#c8e800; --acd:rgba(228,255,26,.1); --acb:rgba(228,255,26,.06);
  --bl:#3b82f6; --bld:rgba(59,130,246,.12);
  --gn:#22c55e; --gnd:rgba(34,197,94,.12);
  --rd:#ef4444; --rdd:rgba(239,68,68,.12);
  --or:#f97316; --ord:rgba(249,115,22,.12);
  --pu:#a855f7; --pud:rgba(168,85,247,.12);
  --cy:#06b6d4; --cyd:rgba(6,182,212,.12);
  --mono:'DM Mono',monospace; --sans:'Syne',sans-serif;
  --r:5px; --rl:10px; --rxl:16px;
}
[data-theme=light] {
  --bg:#f4f4f5; --s0:#ffffff; --s1:#fafafa; --s2:#f4f4f5; --s3:#eeeeef;
  --b0:#e4e4e7; --b1:#d4d4d8; --b2:#a1a1aa;
  --t0:#09090b; --t1:#3f3f46; --t2:#71717a; --t3:#a1a1aa;
  --acd:rgba(228,255,26,.15); --acb:rgba(228,255,26,.08);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
body{background:var(--bg);color:var(--t0);font-family:var(--sans);font-size:14px;line-height:1.5;overflow-x:hidden}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--b1);border-radius:2px}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.shell{display:flex;height:100vh;overflow:hidden}
.rail{width:56px;min-width:56px;background:var(--s0);border-right:1px solid var(--b0);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:2px;z-index:10}
.sidebar{width:220px;min-width:220px;background:var(--s1);border-right:1px solid var(--b0);display:flex;flex-direction:column;overflow:hidden;transition:width .2s}
.sidebar.collapsed{width:0;min-width:0;border:none}
.main{flex:1;overflow-y:auto;min-width:0;background:var(--bg)}
.content{padding:28px 32px;max-width:1280px}

/* ‚îÄ‚îÄ RAIL ‚îÄ‚îÄ */
.ri{width:38px;height:38px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--t2);font-size:17px;transition:all .15s;position:relative}
.ri:hover{background:var(--s2);color:var(--t0)}.ri.on{background:var(--acd);color:var(--ac)}
.ri .tip{position:absolute;left:calc(100% + 8px);background:var(--s3);border:1px solid var(--b0);color:var(--t0);font-size:11px;white-space:nowrap;padding:4px 9px;border-radius:var(--r);pointer-events:none;opacity:0;transition:opacity .15s;font-family:var(--mono);z-index:999}
.ri:hover .tip{opacity:1}
.rail-sep{width:26px;height:1px;background:var(--b0);margin:6px 0}
.rail-logo{width:38px;height:38px;background:var(--ac);border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:11px;font-weight:500;color:#000;margin-bottom:8px;letter-spacing:.05em;cursor:pointer}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sb-head{padding:14px 14px 10px;border-bottom:1px solid var(--b0)}
.sb-title{font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--t2);font-family:var(--mono)}
.sb-list{padding:8px;flex:1;overflow-y:auto}
.sbi{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:var(--r);cursor:pointer;color:var(--t1);font-size:13px;transition:all .1s;user-select:none}
.sbi:hover{background:var(--s2);color:var(--t0)}.sbi.on{background:var(--acb);color:var(--ac);font-weight:600}
.sbi .fdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sbi .badge{margin-left:auto;font-family:var(--mono);font-size:10px;color:var(--t3);background:var(--s3);padding:1px 6px;border-radius:10px}
.sbi.on .badge{background:var(--acd);color:var(--ac)}
.sb-sec{font-family:var(--mono);font-size:9px;font-weight:500;letter-spacing:.12em;text-transform:uppercase;color:var(--t3);padding:12px 8px 4px}
.sbi-indent{padding-left:20px}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{display:flex;align-items:center;gap:12px;padding:16px 32px;border-bottom:1px solid var(--b0);background:var(--s0);position:sticky;top:0;z-index:50}
.page-title{font-size:17px;font-weight:700;letter-spacing:-.02em;flex:1}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:var(--r);border:none;cursor:pointer;font-family:var(--sans);font-size:13px;font-weight:600;transition:all .12s;white-space:nowrap}
.btn-primary{background:var(--ac);color:#000}.btn-primary:hover{background:var(--ac2)}
.btn-ghost{background:transparent;color:var(--t1);border:1px solid var(--b0)}.btn-ghost:hover{background:var(--s2);color:var(--t0)}
.btn-danger{background:var(--rdd);color:var(--rd);border:1px solid rgba(239,68,68,.2)}.btn-danger:hover{background:rgba(239,68,68,.22)}
.btn-success{background:var(--gnd);color:var(--gn);border:1px solid rgba(34,197,94,.2)}
.btn-sm{padding:5px 10px;font-size:12px}.btn-xs{padding:3px 7px;font-size:11px}
.btn-icon{width:32px;height:32px;padding:0;justify-content:center;border-radius:var(--r)}
.btn:disabled{opacity:.4;cursor:not-allowed}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--s1);border:1px solid var(--b0);border-radius:var(--rl);padding:20px}
.doc-card{background:var(--s1);border:1px solid var(--b0);border-radius:var(--rl);padding:16px;cursor:pointer;transition:all .15s;position:relative}
.doc-card:hover{border-color:var(--b1);background:var(--s2);transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.doc-card.selected{border-color:var(--ac);background:var(--acd)}
.doc-card.tombstone{opacity:.4;border-style:dashed}
.doc-card.pinned::after{content:'üìå';position:absolute;top:10px;right:12px;font-size:11px}

/* ‚îÄ‚îÄ GRID LAYOUTS ‚îÄ‚îÄ */
.grid-docs{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
.grid-files{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.grid-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.list-view{display:flex;flex-direction:column;gap:6px}

/* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
.stat-card{background:var(--s1);border:1px solid var(--b0);border-radius:var(--rl);padding:16px}
.stat-val{font-family:var(--mono);font-size:28px;font-weight:500;line-height:1;margin-bottom:4px}
.stat-label{font-size:11px;color:var(--t2);font-weight:500;letter-spacing:.04em}
.stat-sub{font-family:var(--mono);font-size:10px;color:var(--t3);margin-top:2px}
.c-ac .stat-val{color:var(--ac)} .c-gn .stat-val{color:var(--gn)}
.c-bl .stat-val{color:var(--bl)} .c-pu .stat-val{color:var(--pu)}
.c-or .stat-val{color:var(--or)} .c-cy .stat-val{color:var(--cy)}

/* ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ */
.tag{display:inline-flex;align-items:center;gap:2px;padding:2px 7px;border-radius:4px;font-family:var(--mono);font-size:11px}
.tag-user{background:var(--bld);color:var(--bl)}.tag-ai{background:var(--pud);color:var(--pu)}
.tag-file{background:var(--gnd);color:var(--gn)}.tag-warn{background:var(--ord);color:var(--or)}
.tag-status{padding:2px 8px;border-radius:4px;font-family:var(--mono);font-size:10px;font-weight:500;letter-spacing:.04em}
.s-todo{background:var(--s3);color:var(--t2)}.s-prog{background:var(--bld);color:var(--bl)}
.s-review{background:var(--ord);color:var(--or)}.s-done{background:var(--gnd);color:var(--gn)}

/* ‚îÄ‚îÄ STORAGE BADGES ‚îÄ‚îÄ */
.store-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-family:var(--mono);font-size:10px;font-weight:500}
.sb-local{background:rgba(34,197,94,.12);color:var(--gn);border:1px solid rgba(34,197,94,.2)}
.sb-github{background:rgba(250,250,250,.07);color:var(--t1);border:1px solid var(--b0)}
.sb-drive{background:rgba(59,130,246,.12);color:var(--bl);border:1px solid rgba(59,130,246,.2)}
.sb-off{background:var(--s3);color:var(--t3);border:1px solid var(--b0)}

/* ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ */
.toggle{width:38px;height:20px;background:var(--s3);border-radius:10px;position:relative;cursor:pointer;transition:background .2s;border:1px solid var(--b0);flex-shrink:0}
.toggle.on{background:var(--ac);border-color:var(--ac)}
.toggle::after{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:2px;left:2px;transition:left .2s}
.toggle.on::after{left:20px;background:#000}

/* ‚îÄ‚îÄ STORAGE PANEL ‚îÄ‚îÄ */
.storage-panel{background:var(--s1);border:1px solid var(--b0);border-radius:var(--rl);overflow:hidden}
.storage-backend{padding:16px 20px;border-bottom:1px solid var(--b0);display:flex;align-items:flex-start;gap:14px}
.storage-backend:last-child{border-bottom:none}
.sb-icon{width:40px;height:40px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.sb-info{flex:1}.sb-name{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px;margin-bottom:2px}
.sb-desc{font-size:12px;color:var(--t2);line-height:1.5}
.sb-meta{font-family:var(--mono);font-size:10px;color:var(--t3);margin-top:4px}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(6px)}
.modal{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rxl);width:100%;max-width:720px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 32px 96px rgba(0,0,0,.6)}
.modal-lg{max-width:960px}.modal-sm{max-width:480px}.modal-xs{max-width:380px}
.modal-head{padding:16px 20px 14px;border-bottom:1px solid var(--b0);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.modal-title{font-size:15px;font-weight:700}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-foot{padding:12px 20px;border-top:1px solid var(--b0);display:flex;justify-content:flex-end;gap:8px;flex-shrink:0}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.fg{margin-bottom:14px}
.fl{font-size:11px;font-weight:600;color:var(--t1);margin-bottom:5px;display:block;letter-spacing:.04em;text-transform:uppercase;font-family:var(--mono)}
.fi{width:100%;background:var(--s2);border:1px solid var(--b0);border-radius:var(--r);padding:9px 11px;color:var(--t0);font-family:var(--sans);font-size:13px;outline:none;transition:border-color .15s}
.fi:focus{border-color:var(--ac)}.fi-mono{font-family:var(--mono);font-size:12px}
.fta{resize:vertical;min-height:140px;line-height:1.6}
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fhelp{font-size:11px;color:var(--t3);margin-top:3px;font-family:var(--mono)}

/* ‚îÄ‚îÄ TAG INPUT ‚îÄ‚îÄ */
.tag-wrap{display:flex;flex-wrap:wrap;gap:5px;background:var(--s2);border:1px solid var(--b0);border-radius:var(--r);padding:7px;cursor:text;min-height:38px;align-items:center}
.tag-wrap:focus-within{border-color:var(--ac)}
.tag-wrap input{border:none;background:transparent;color:var(--t0);font-family:var(--mono);font-size:12px;outline:none;flex:1;min-width:70px}
.tag-pill{display:inline-flex;align-items:center;gap:3px;background:var(--acd);color:var(--ac);border-radius:4px;padding:2px 7px;font-family:var(--mono);font-size:11px}
.tag-pill button{background:none;border:none;color:inherit;cursor:pointer;padding:0;opacity:.6;line-height:1}.tag-pill button:hover{opacity:1}
.tag-sugs{position:absolute;top:calc(100% + 3px);left:0;right:0;background:var(--s2);border:1px solid var(--b1);border-radius:var(--rl);box-shadow:0 12px 40px rgba(0,0,0,.4);z-index:300;max-height:180px;overflow-y:auto}
.tag-si{display:flex;align-items:center;gap:7px;padding:7px 10px;cursor:pointer;transition:background .1s}
.tag-si:hover,.tag-si.act{background:var(--s3)}

/* ‚îÄ‚îÄ CMD PALETTE ‚îÄ‚îÄ */
.cmd-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:1000;display:flex;align-items:flex-start;justify-content:center;padding-top:80px;backdrop-filter:blur(5px)}
.cmd-box{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rxl);width:100%;max-width:580px;box-shadow:0 32px 80px rgba(0,0,0,.65);overflow:hidden}
.cmd-inp{width:100%;background:transparent;border:none;border-bottom:1px solid var(--b0);padding:14px 16px;font-family:var(--sans);font-size:15px;color:var(--t0);outline:none}
.cmd-results{max-height:340px;overflow-y:auto}
.cmd-item{display:flex;align-items:center;gap:10px;padding:9px 14px;cursor:pointer;transition:background .1s}
.cmd-item:hover,.cmd-item.act{background:var(--s2)}
.cmd-ico{width:28px;height:28px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;background:var(--s3)}
.cmd-grp{font-family:var(--mono);font-size:9px;color:var(--t3);letter-spacing:.12em;text-transform:uppercase;padding:8px 14px 3px;background:var(--s1)}

/* ‚îÄ‚îÄ FILE CARDS ‚îÄ‚îÄ */
.file-card{background:var(--s2);border:1px solid var(--b0);border-radius:var(--rl);padding:12px;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:all .15s;position:relative}
.file-card:hover{border-color:var(--b1);background:var(--s3)}
.file-card.selected{border-color:var(--ac);background:var(--acd)}
.file-icon{font-size:32px;margin-bottom:7px;line-height:1}
.file-name{font-size:11px;color:var(--t0);text-align:center;word-break:break-all;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.file-size{font-family:var(--mono);font-size:10px;color:var(--t3);margin-top:3px}
.file-type-badge{font-family:var(--mono);font-size:9px;padding:1px 5px;border-radius:3px;margin-top:3px;text-transform:uppercase;font-weight:500}

/* ‚îÄ‚îÄ DROPZONE ‚îÄ‚îÄ */
.dropzone{border:2px dashed var(--b1);border-radius:var(--rl);padding:40px 20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--s2)}
.dropzone.over{border-color:var(--ac);background:var(--acd)}
.dz-icon{font-size:36px;margin-bottom:10px;opacity:.4}
.dz-text{font-size:13px;color:var(--t1);margin-bottom:4px;font-weight:600}
.dz-hint{font-size:11px;color:var(--t3);font-family:var(--mono)}

/* ‚îÄ‚îÄ DIFF ‚îÄ‚îÄ */
.diff-view{font-family:var(--mono);font-size:11px;line-height:1.7;border:1px solid var(--b0);border-radius:var(--r);overflow:hidden}
.diff-line{padding:1px 12px;display:flex;gap:8px}
.diff-line.add{background:rgba(34,197,94,.1)}.diff-line.del{background:rgba(239,68,68,.1)}
.diff-ln{color:var(--t3);min-width:24px;user-select:none}

/* ‚îÄ‚îÄ KANBAN ‚îÄ‚îÄ */
.kanban{display:flex;gap:12px;overflow-x:auto;padding-bottom:12px;min-height:400px}
.kbcol{min-width:230px;max-width:240px;background:var(--s2);border:1px solid var(--b0);border-radius:var(--rl);display:flex;flex-direction:column;flex-shrink:0}
.kbh{padding:11px 14px;font-size:12px;font-weight:700;border-bottom:1px solid var(--b0);display:flex;align-items:center;justify-content:space-between;letter-spacing:.03em}
.kbb{padding:8px;display:flex;flex-direction:column;gap:6px;flex:1;overflow-y:auto;max-height:480px}
.kb-card{background:var(--s1);border:1px solid var(--b0);border-radius:var(--r);padding:10px;cursor:pointer;transition:all .15s}
.kb-card:hover{border-color:var(--b1);box-shadow:0 4px 12px rgba(0,0,0,.2)}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.prog-bar{height:4px;background:var(--s3);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:var(--ac);transition:width .4s;border-radius:2px}
.prog-fill.gn{background:var(--gn)}.prog-fill.rd{background:var(--rd)}.prog-fill.bl{background:var(--bl)}

/* ‚îÄ‚îÄ TOASTS ‚îÄ‚îÄ */
.toast-container{position:fixed;top:14px;right:14px;z-index:2000;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:10px 14px;font-size:12px;color:var(--t0);box-shadow:0 8px 32px rgba(0,0,0,.4);min-width:200px;display:flex;align-items:center;gap:8px;font-family:var(--mono);animation:slideIn .2s ease}
@keyframes slideIn{from{opacity:0;transform:translateX(16px)}}
.toast.success{border-left:3px solid var(--gn)}.toast.error{border-left:3px solid var(--rd)}
.toast.info{border-left:3px solid var(--bl)}.toast.warn{border-left:3px solid var(--or)}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;gap:1px;background:var(--s2);border-radius:var(--r);padding:3px;border:1px solid var(--b0)}
.tab{padding:5px 13px;border-radius:4px;cursor:pointer;font-size:12px;color:var(--t2);transition:all .1s;font-weight:500}
.tab.on{background:var(--s1);color:var(--t0)}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center}
.empty-ico{font-size:44px;margin-bottom:12px;opacity:.2}
.empty-txt{font-size:14px;color:var(--t2);margin-bottom:4px;font-weight:600}
.empty-hint{font-size:12px;color:var(--t3);font-family:var(--mono)}
.sep{height:1px;background:var(--b0);margin:16px 0}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.section-title{font-size:13px;font-weight:700;letter-spacing:.04em;text-transform:uppercase;color:var(--t2);font-family:var(--mono)}
.spinner{width:14px;height:14px;border:2px solid var(--b1);border-top-color:var(--ac);border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}}
.fade-in{animation:fadeIn .25s ease}
.dot-pulse::after{content:'...';animation:dots 1.2s steps(4,end) infinite}
@keyframes dots{0%,20%{content:''}40%{content:'.'}60%{content:'..'}80%,100%{content:'...'}}

/* ‚îÄ‚îÄ AI PANEL ‚îÄ‚îÄ */
.ai-panel{background:linear-gradient(135deg,var(--pud),transparent);border:1px solid rgba(168,85,247,.2);border-radius:var(--rl);padding:14px}
.ai-label{font-family:var(--mono);font-size:9px;color:var(--pu);font-weight:500;letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px}

/* ‚îÄ‚îÄ SSE STREAM INDICATOR ‚îÄ‚îÄ */
.stream-bar{background:var(--s1);border:1px solid var(--b0);border-radius:var(--r);padding:8px 12px;display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:11px;color:var(--t2);margin-bottom:12px}
.stream-dot{width:7px;height:7px;border-radius:50%;background:var(--ac);animation:pulse 1.2s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ FOLDER TREE ‚îÄ‚îÄ */
.folder-node{border-radius:var(--r);overflow:hidden}
.folder-row{display:flex;align-items:center;gap:7px;padding:7px 8px;cursor:pointer;transition:background .1s;border-radius:var(--r)}
.folder-row:hover{background:var(--s2)}
.folder-row.on{background:var(--acb);color:var(--ac)}
.folder-toggle{width:14px;color:var(--t3);font-size:10px;transition:transform .15s;flex-shrink:0}
.folder-children{padding-left:14px}

/* ‚îÄ‚îÄ SETTINGS GROUPS ‚îÄ‚îÄ */
.set-group{background:var(--s1);border:1px solid var(--b0);border-radius:var(--rl);margin-bottom:12px;overflow:hidden}
.set-group-head{padding:12px 16px;border-bottom:1px solid var(--b0);font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--t2);background:var(--s2)}
.set-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--b0)}
.set-row:last-child{border-bottom:none}
.set-lbl{font-size:13px;color:var(--t0);font-weight:500}
.set-desc{font-size:11px;color:var(--t3);margin-top:2px;font-family:var(--mono)}

/* ‚îÄ‚îÄ SELECTION BAR ‚îÄ‚îÄ */
.sel-bar{position:sticky;bottom:12px;margin:0 auto;width:fit-content;background:var(--s1);border:1px solid var(--ac);border-radius:var(--rl);padding:8px 16px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 32px rgba(228,255,26,.15);font-size:13px;font-weight:600}

/* ‚îÄ‚îÄ STORAGE STATUS DOT ‚îÄ‚îÄ */
.sdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sdot.on{background:var(--gn);box-shadow:0 0 6px var(--gn)}.sdot.off{background:var(--t3)}

/* ‚îÄ‚îÄ INGEST TABS ‚îÄ‚îÄ */
.ingest-tab{flex:1;padding:14px;text-align:center;cursor:pointer;border-radius:var(--r);transition:all .15s;border:2px solid transparent}
.ingest-tab.on{border-color:var(--ac);background:var(--acd);color:var(--ac)}
.ingest-tab:not(.on){color:var(--t2);background:var(--s2)}
.ingest-tab:not(.on):hover{background:var(--s3)}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:768px){
  .sidebar{position:fixed;left:56px;top:0;bottom:0;z-index:40}
  .sidebar.collapsed{transform:translateX(-220px)}
  .grid-docs{grid-template-columns:1fr}
  .grid-stats{grid-template-columns:1fr 1fr}
  .fr2{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useCallback,useMemo,useRef,createContext,useContext}=React;

// ‚îÄ‚îÄ API BASE (mutable at runtime via settings) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let API_BASE = localStorage.getItem('akrs-api') || 'http://localhost:8000/api/v1';
const getAPI = () => API_BASE;

// ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmtBytes = b => !b ? '0B' : b < 1024 ? b+'B' : b < 1048576 ? (b/1024).toFixed(1)+'KB' : (b/1048576).toFixed(1)+'MB';
const tAgo = iso => {
  if(!iso) return '‚Äî';
  const s = Math.floor((Date.now()-new Date(iso))/1000);
  if(s<60) return 'just now'; if(s<3600) return Math.floor(s/60)+'m ago';
  if(s<86400) return Math.floor(s/3600)+'h ago'; return Math.floor(s/86400)+'d ago';
};
const statusClass = s => ({'Todo':'s-todo','In Progress':'s-prog','In Review':'s-review','Done':'s-done'}[s]||'s-todo');
const fileIcon = t => ({'pdf':'üìÑ','png':'üñºÔ∏è','jpg':'üñºÔ∏è','jpeg':'üñºÔ∏è','gif':'üñºÔ∏è','mp4':'üé¨','mp3':'üéµ','xlsx':'üìä','xls':'üìä','csv':'üìä','docx':'üìù','doc':'üìù','zip':'üóúÔ∏è','sh':'‚öôÔ∏è','py':'üêç','js':'‚ö°','ts':'‚ö°','jsx':'‚ö°','tsx':'‚ö°','json':'üìã','sql':'üóÑÔ∏è','md':'üìÉ','txt':'üìÉ','go':'üîµ','rs':'ü¶Ä','java':'‚òï','kt':'üì±'})[t?.toLowerCase()] || 'üìé';
const fileColor = t => ({'pdf':'#ef4444','png':'#a855f7','jpg':'#a855f7','xlsx':'#22c55e','csv':'#22c55e','docx':'#3b82f6','zip':'#71717a','sh':'#06b6d4','py':'#3b82f6','js':'#f59e0b','ts':'#3b82f6','sql':'#059669','md':'#94a3b8','go':'#06b6d4','rs':'#f97316'})[t?.toLowerCase()] || '#52525b';
const parseList = v => { if(Array.isArray(v)) return v; try { return JSON.parse(v||'[]'); } catch { return []; }};

function useDebounce(v,d){const[s,ss]=useState(v);useEffect(()=>{const t=setTimeout(()=>ss(v),d);return()=>clearTimeout(t);},[v,d]);return s;}
function useLS(key,init){
  const[v,sv]=useState(()=>{try{const s=localStorage.getItem(key);return s?JSON.parse(s):init;}catch{return init;}});
  const set=useCallback(nv=>{sv(nv);try{localStorage.setItem(key,JSON.stringify(nv));}catch{}},[key]);
  return[v,set];
}
function useToast(){
  const[ts,sTs]=useState([]);
  const add=useCallback((msg,type='info')=>{const id=Date.now();sTs(a=>[...a,{id,msg,type}]);setTimeout(()=>sTs(a=>a.filter(x=>x.id!==id)),3500);},[]);
  return{toasts:ts,toast:add};
}

// ‚îÄ‚îÄ API HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Only set Content-Type on requests that actually send a JSON body.
// GET/DELETE with no Content-Type header are "simple" requests and won't
// trigger a CORS preflight ‚Äî fixing the 400 OPTIONS errors.
const apiFetch = async (path, opts={}) => {
  const r = await fetch(getAPI() + path, opts);
  if(!r.ok) { const e = await r.json().catch(()=>({detail:r.statusText})); throw new Error(e.detail||r.statusText); }
  return r.json();
};
const apiPost = (path, body) => apiFetch(path, {
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify(body),
});
const apiPatch = (path, body) => apiFetch(path, {
  method:'PATCH',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify(body),
});
const apiDelete = path => apiFetch(path, {method:'DELETE'});

// ‚îÄ‚îÄ DEMO FALLBACKS (used when backend is not reachable) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEMO_FOLDERS = [
  {id:'f1',name:'Engineering',slug:'engineering',color:'#3b82f6',icon:'‚öôÔ∏è',parent_id:null},
  {id:'f2',name:'Security',slug:'security',color:'#ef4444',icon:'üîê',parent_id:null},
  {id:'f3',name:'APIs',slug:'apis',color:'#f59e0b',icon:'‚ö°',parent_id:null},
  {id:'f4',name:'DevOps',slug:'devops',color:'#8b5cf6',icon:'üöÄ',parent_id:null},
  {id:'f5',name:'Architecture',slug:'architecture',color:'#22c55e',icon:'üèóÔ∏è',parent_id:null},
];
const DEMO_DOCS = [
  {id:'d1',title:'JWT Authentication Architecture',content:'# JWT Auth\n\nRS256 token signing with 15-min expiry.',user_tags:['auth','jwt','security'],ai_tags:['authentication','authorization','OAuth'],ai_summary:'JWT authentication with RS256 token rotation.',folder_ids:['f1','f2'],status:'In Review',pinned:true,bookmarked:true,is_active:true,version:3,created_at:new Date(Date.now()-864e5).toISOString(),updated_at:new Date(Date.now()-3600e3).toISOString()},
  {id:'d2',title:'PostgreSQL Full-Text Search Setup',content:'# FTS\n\nGIN indexes and TSVECTOR for BM25.',user_tags:['database','search','postgresql'],ai_tags:['SQL','GIN','BM25','TSVECTOR'],ai_summary:'PostgreSQL FTS using GIN indexes and BM25.',folder_ids:['f1'],status:'Done',pinned:false,bookmarked:false,is_active:true,version:2,created_at:new Date(Date.now()-2592e5).toISOString(),updated_at:new Date(Date.now()-86e6).toISOString()},
  {id:'d3',title:'API Rate Limiting Strategy',content:'# Rate Limiting\n\nSliding window per API key.',user_tags:['api','rate-limiting'],ai_tags:['REST','throttling','Redis'],ai_summary:'Sliding window rate limiting per client key.',folder_ids:['f3'],status:'Todo',pinned:false,bookmarked:true,is_active:true,version:1,created_at:new Date(Date.now()-432e5).toISOString(),updated_at:new Date(Date.now()-432e5).toISOString()},
];
const DEMO_FILES = [
  {id:'fi1',name:'architecture-diagram.png',file_type:'png',mime_type:'image/png',size_bytes:204800,tags:['diagram'],folder_ids:['f5'],uploaded_at:new Date(Date.now()-86e6).toISOString()},
  {id:'fi2',name:'api-spec.pdf',file_type:'pdf',mime_type:'application/pdf',size_bytes:512000,tags:['api','spec'],folder_ids:['f3'],uploaded_at:new Date(Date.now()-172e6).toISOString()},
];
const DEMO_STORAGE = {config:{local:{enabled:true,base_dir:'./data/files'},github:{enabled:false,repo:'',branch:'main',path:'uploads'},drive:{enabled:false,folder_id:''}},active_backends:['local'],cost_estimate:{notes:['Local: FREE (disk only)']}};

// ‚îÄ‚îÄ TAG INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function TagInput({value,onChange,placeholder='Add tags‚Ä¶'}){
  const[inp,sI]=useState('');const[sugs,sSugs]=useState([]);const[idx,sIdx]=useState(-1);
  const db=useDebounce(inp,160);
  useEffect(()=>{
    if(db.length<1){sSugs([]);return;}
    apiFetch(`/tags?prefix=${encodeURIComponent(db)}&limit=6`).then(d=>sSugs(d.tags||[])).catch(()=>{});
  },[db]);
  const add=tag=>{tag=tag.trim().toLowerCase();if(tag&&!value.includes(tag))onChange([...value,tag]);sI('');sSugs([]);};
  const rem=tag=>onChange(value.filter(t=>t!==tag));
  return(<div style={{position:'relative'}}>
    <div className="tag-wrap">
      {value.map(t=><span key={t} className="tag-pill">{t}<button onClick={()=>rem(t)}>√ó</button></span>)}
      <input value={inp} onChange={e=>sI(e.target.value)} onKeyDown={e=>{
        if((e.key===','||e.key==='Enter')&&inp){e.preventDefault();add(inp);}
        if(e.key==='Backspace'&&!inp&&value.length)rem(value[value.length-1]);
        if(e.key==='ArrowDown'){e.preventDefault();sIdx(i=>Math.min(i+1,sugs.length-1));}
        if(e.key==='ArrowUp'){e.preventDefault();sIdx(i=>Math.max(i-1,-1));}
        if(e.key==='Enter'&&idx>=0&&sugs[idx]){add(sugs[idx].tag);sIdx(-1);}
        if(e.key==='Escape')sSugs([]);
      }} placeholder={value.length?'':placeholder}/>
    </div>
    {sugs.length>0&&<div className="tag-sugs">{sugs.map((s,i)=><div key={s.tag} className={`tag-si${i===idx?' act':''}`} onMouseDown={e=>{e.preventDefault();add(s.tag);}}>
      <span className="tag" style={{background:'var(--acd)',color:'var(--ac)'}}>{s.tag}</span>
      <span style={{fontSize:10,color:'var(--t3)',fontFamily:'var(--mono)',marginLeft:'auto'}}>√ó{s.use_count}</span>
    </div>)}</div>}
  </div>);
}

// ‚îÄ‚îÄ STORAGE BADGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function StorageBadges({locations}){
  if(!locations) return null;
  const loc = typeof locations === 'string' ? JSON.parse(locations||'{}') : locations;
  return(<div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:4}}>
    {loc.local&&<span className="store-badge sb-local">üíæ Local</span>}
    {loc.github&&<span className="store-badge sb-github">üêô GitHub</span>}
    {loc.drive&&<span className="store-badge sb-drive">‚òÅÔ∏è Drive</span>}
    {!loc.local&&!loc.github&&!loc.drive&&<span className="store-badge sb-off">Not saved</span>}
  </div>);
}

// ‚îÄ‚îÄ CMD PALETTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function CmdPalette({onClose,onNav,docs}){
  const[q,sQ]=useState('');const[idx,sIdx]=useState(0);const db=useDebounce(q,80);const ref=useRef();
  useEffect(()=>ref.current?.focus(),[]);
  const cmds=useMemo(()=>[
    {grp:'Navigate',items:[
      {lbl:'Dashboard',ico:'üè†',act:()=>onNav('dashboard')},
      {lbl:'New Document/File',ico:'‚úö',act:()=>onNav('ingest')},
      {lbl:'Documents',ico:'üìö',act:()=>onNav('docs')},
      {lbl:'Search',ico:'üîç',act:()=>onNav('search')},
      {lbl:'Files',ico:'üìÅ',act:()=>onNav('files')},
      {lbl:'Folders',ico:'üóÇÔ∏è',act:()=>onNav('folders')},
      {lbl:'Storage',ico:'üóÑÔ∏è',act:()=>onNav('storage')},
      {lbl:'Analytics',ico:'üìä',act:()=>onNav('analytics')},
      {lbl:'Settings',ico:'‚öôÔ∏è',act:()=>onNav('settings')},
    ]},
    {grp:'Documents',items:(docs||[]).filter(d=>d.is_active).filter(d=>!db||d.title.toLowerCase().includes(db.toLowerCase())).slice(0,5).map(d=>({lbl:d.title,ico:'üìÑ',act:()=>onNav('docs',d)}))},
  ],[docs,db,onNav]);
  const flat=useMemo(()=>cmds.flatMap(g=>g.items).filter(i=>!db||i.lbl.toLowerCase().includes(db.toLowerCase())),[cmds,db]);
  useEffect(()=>sIdx(0),[db]);
  const hk=e=>{if(e.key==='ArrowDown'){e.preventDefault();sIdx(i=>Math.min(i+1,flat.length-1));}if(e.key==='ArrowUp'){e.preventDefault();sIdx(i=>Math.max(i-1,0));}if(e.key==='Enter'&&flat[idx]){flat[idx].act();onClose();}if(e.key==='Escape')onClose();};
  let fi=-1;
  return(<div className="cmd-overlay" onClick={onClose}><div className="cmd-box" onClick={e=>e.stopPropagation()}>
    <input ref={ref} className="cmd-inp" placeholder="Search commands, docs‚Ä¶" value={q} onChange={e=>sQ(e.target.value)} onKeyDown={hk}/>
    <div className="cmd-results">{cmds.map(g=>{const items=g.items.filter(i=>!db||i.lbl.toLowerCase().includes(db.toLowerCase()));if(!items.length)return null;return(<div key={g.grp}><div className="cmd-grp">{g.grp}</div>{items.map(it=>{fi++;const ci=fi;return(<div key={it.lbl} className={`cmd-item${ci===idx?' act':''}`} onMouseDown={()=>{it.act();onClose();}}><div className="cmd-ico">{it.ico}</div><span style={{fontSize:13,fontWeight:500}}>{it.lbl}</span></div>);})}</div>);})}</div>
    <div style={{padding:'8px 14px',borderTop:'1px solid var(--b0)',display:'flex',gap:10,fontFamily:'var(--mono)',fontSize:10,color:'var(--t3)'}}>
      <span>‚Üë‚Üì Navigate</span><span>‚Üµ Select</span><span>Esc Close</span>
    </div>
  </div></div>);
}

// ‚îÄ‚îÄ INGEST MODAL (unified create doc + upload file) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function IngestModal({folders,onClose,onDone,toast,storageConfig}){
  const[mode,sMode]=useState('doc'); // 'doc' | 'file'
  const[title,sT]=useState('');const[content,sC]=useState('');
  const[tags,sTags]=useState([]);const[fids,sFids]=useState([]);
  const[status,setSt]=useState('Todo');const[saving,sSav]=useState(false);
  const[aiTags,sAiTags]=useState([]);const[largeContent,sLarge]=useState(false);
  const[dragging,sDrag]=useState(false);const[files,sFiles]=useState([]);
  const activeBackends=(storageConfig?.active_backends)||['local'];

  const save=async()=>{
    if(mode==='doc'&&!title.trim()){toast('Title required','warn');return;}
    if(mode==='file'&&!files.length){toast('Select a file','warn');return;}
    sSav(true);
    try{
      const fd=new FormData();
      if(mode==='file'){
        fd.append('file',files[0]);
        if(title) fd.append('title',title);
      } else {
        fd.append('title',title);
        fd.append('content',content);
        fd.append('content_type','markdown');
        fd.append('status',status);
      }
      fd.append('tags',tags.join(','));
      fd.append('folder_ids',fids.join(','));

      const r=await fetch(getAPI()+'/ingest',{method:'POST',body:fd});
      if(!r.ok) throw new Error((await r.json().catch(()=>({}))).detail||r.statusText);
      const data=await r.json();
      sAiTags(parseList(data.ai_tags)||[]);
      sLarge(data.large_content||false);
      toast(mode==='file'?`File uploaded ‚Üí ${(data.storage||{local:{}}).local?'local ':''}${(data.storage||{}).github?'github ':''}${(data.storage||{}).drive?'drive':''}`.trim()||'Uploaded':'Document created','success');
      onDone(data);
      onClose();
    }catch(e){toast(e.message||'Failed','error');}
    finally{sSav(false);}
  };

  const handleDrop=e=>{e.preventDefault();sDrag(false);const f=[...e.dataTransfer.files];if(f.length)sFiles(f);};

  return(<div className="overlay"><div className="modal fade-in" onClick={e=>e.stopPropagation()}>
    <div className="modal-head">
      <span className="modal-title">New Document / File</span>
      <button className="btn btn-ghost btn-sm" onClick={onClose}>‚úï</button>
    </div>
    <div className="modal-body">
      {/* Mode switcher */}
      <div style={{display:'flex',gap:8,marginBottom:20}}>
        <div className={`ingest-tab${mode==='doc'?' on':''}`} onClick={()=>sMode('doc')}>
          <div style={{fontSize:24,marginBottom:4}}>üìù</div>
          <div style={{fontWeight:700,fontSize:13}}>Write Document</div>
          <div style={{fontSize:11,color:'var(--t2)',marginTop:2,fontFamily:'var(--mono)'}}>Markdown, text, notes</div>
        </div>
        <div className={`ingest-tab${mode==='file'?' on':''}`} onClick={()=>sMode('file')}>
          <div style={{fontSize:24,marginBottom:4}}>üìÇ</div>
          <div style={{fontWeight:700,fontSize:13}}>Upload File</div>
          <div style={{fontSize:11,color:'var(--t2)',marginTop:2,fontFamily:'var(--mono)'}}>PDF, DOCX, images, code</div>
        </div>
      </div>

      {mode==='doc'&&<>
        <div className="fg"><label className="fl">Title</label><input className="fi" value={title} onChange={e=>sT(e.target.value)} placeholder="Document title‚Ä¶" autoFocus/></div>
        <div className="fg"><label className="fl">Content (Markdown)</label><textarea className="fi fta fi-mono" value={content} onChange={e=>sC(e.target.value)} placeholder="Write in markdown‚Ä¶" style={{minHeight:180}}/></div>
        <div className="fg"><label className="fl">Status</label>
          <select className="fi" value={status} onChange={e=>setSt(e.target.value)}>
            {['Todo','In Progress','In Review','Done'].map(s=><option key={s}>{s}</option>)}
          </select>
        </div>
      </>}

      {mode==='file'&&<>
        <div className={`dropzone${dragging?' over':''}`} style={{marginBottom:14}} onDragOver={e=>{e.preventDefault();sDrag(true);}} onDragLeave={()=>sDrag(false)} onDrop={handleDrop} onClick={()=>document.getElementById('ingest-file-inp')?.click()}>
          {files.length?<><div style={{fontSize:32,marginBottom:6}}>{fileIcon(files[0].name.split('.').pop())}</div><div style={{fontSize:13,fontWeight:600}}>{files[0].name}</div><div style={{fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)',marginTop:3}}>{fmtBytes(files[0].size)}</div></>:<><div className="dz-icon">üìÇ</div><div className="dz-text">Drop file here or click to pick</div><div className="dz-hint">PDF, DOCX, XLSX, code, images ‚Äî max 100 MB</div></>}
        </div>
        <input id="ingest-file-inp" type="file" style={{display:'none'}} onChange={e=>sFiles([...e.target.files])}/>
        <div className="fg"><label className="fl">Title (optional)</label><input className="fi" value={title} onChange={e=>sT(e.target.value)} placeholder={files[0]?.name||'Auto from filename‚Ä¶'}/></div>
      </>}

      <div className="fr2">
        <div className="fg"><label className="fl">Tags</label><TagInput value={tags} onChange={sTags}/><div className="fhelp">AI will add more tags automatically (max 30)</div></div>
        <div className="fg"><label className="fl">Folders</label>
          <div style={{display:'flex',flexWrap:'wrap',gap:5}}>
            {folders.map(f=><div key={f.id} onClick={()=>sFids(ids=>ids.includes(f.id)?ids.filter(i=>i!==f.id):[...ids,f.id])} style={{display:'inline-flex',alignItems:'center',gap:5,padding:'4px 9px',borderRadius:'var(--r)',border:'1px solid',cursor:'pointer',fontSize:12,background:fids.includes(f.id)?f.color+'22':'transparent',borderColor:fids.includes(f.id)?f.color:'var(--b0)',color:fids.includes(f.id)?f.color:'var(--t2)',transition:'all .1s'}}>
              {f.icon}{f.name}
            </div>)}
          </div>
          <div className="fhelp">Leave empty to auto-assign by tag match</div>
        </div>
      </div>

      {aiTags.length>0&&<div className="ai-panel"><div className="ai-label">‚ú¶ AI Generated Tags</div><div style={{display:'flex',flexWrap:'wrap',gap:4}}>{aiTags.map(t=><span key={t} className="tag tag-ai">{t}</span>)}</div>{largeContent&&<div style={{marginTop:6,fontSize:11,color:'var(--pu)',fontFamily:'var(--mono)'}}>‚ü≥ Large content detected ‚Äî used representative text extraction</div>}</div>}

      <div style={{background:'var(--s2)',borderRadius:'var(--r)',padding:'8px 12px',fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)',display:'flex',alignItems:'center',gap:6}}>
        üì¶ Saves to: {activeBackends.join(' + ')||'no backend'}
      </div>
    </div>
    <div className="modal-foot">
      <button className="btn btn-ghost btn-sm" onClick={onClose}>Cancel</button>
      <button className="btn btn-primary" onClick={save} disabled={saving}>{saving?<><span className="spinner"/>&nbsp;{mode==='file'?'Uploading‚Ä¶':'Creating‚Ä¶'}</>:mode==='file'?'‚¨Ü Upload':'‚úì Create'}</button>
    </div>
  </div></div>);
}

// ‚îÄ‚îÄ DOC MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function DocModal({doc,folders,onClose,onSave,onDelete,docs,toast}){
  const[title,sT]=useState(doc?.title||'');const[content,sC]=useState(doc?.content||'');
  const[tags,sTags]=useState(parseList(doc?.user_tags)||[]);
  const[fids,sFids]=useState(parseList(doc?.folder_ids)||[]);
  const[status,setSt]=useState(doc?.status||'Todo');const[saving,sSav]=useState(false);
  const[tab,sTab]=useState('edit');const[versions,sVer]=useState([]);

  useEffect(()=>{
    if(doc?.id&&tab==='versions'){
      apiFetch(`/versions/${doc.id}`).then(d=>sVer(d.versions||[])).catch(()=>{});
    }
  },[doc?.id,tab]);

  const related=useMemo(()=>{
    if(!doc||!docs)return[];
    const my=new Set([...(parseList(doc.user_tags)),...(parseList(doc.ai_tags))]);
    return docs.filter(d=>d.id!==doc.id&&d.is_active).map(d=>{
      const dt=new Set([...(parseList(d.user_tags)),...(parseList(d.ai_tags))]);
      const inter=[...my].filter(t=>dt.has(t)).length;
      return{...d,score:inter};
    }).filter(d=>d.score>0).sort((a,b)=>b.score-a.score).slice(0,3);
  },[doc,docs]);

  const save=async()=>{
    if(!title.trim())return;sSav(true);
    try{
      let data;
      if(doc?.id){
        data=await apiPatch(`/documents/${doc.id}`,{title,content,user_tags:tags,folder_ids:fids,status});
      }else{
        const fd=new FormData();
        fd.append('title',title);fd.append('content',content);
        fd.append('content_type','markdown');fd.append('status',status);
        fd.append('tags',tags.join(','));fd.append('folder_ids',fids.join(','));
        const r=await fetch(getAPI()+'/ingest',{method:'POST',body:fd});
        if(!r.ok) throw new Error((await r.json().catch(()=>({}))).detail||r.statusText);
        data=await r.json();
      }
      onSave(data);onClose();
      toast(doc?.id?'Document updated':'Document created','success');
    }catch(e){toast(e.message||'Save failed','error');}
    finally{sSav(false);}
  };

  const aiTagsList = parseList(doc?.ai_tags);

  return(<div className="overlay"><div className="modal modal-lg fade-in" onClick={e=>e.stopPropagation()}>
    <div className="modal-head">
      <span className="modal-title">{doc?.id?'Edit Document':'New Document'}</span>
      <div style={{display:'flex',gap:6,alignItems:'center'}}>
        {doc?.id&&<span className="tag" style={{background:'var(--s3)',color:'var(--t3)',fontFamily:'var(--mono)',fontSize:10}}>v{doc.version||1}</span>}
        {doc?.storage_locations&&<StorageBadges locations={doc.storage_locations}/>}
        <button className="btn btn-ghost btn-sm" onClick={onClose}>‚úï</button>
      </div>
    </div>
    <div style={{padding:'0 20px',borderBottom:'1px solid var(--b0)'}}>
      <div className="tabs">{['edit','preview','related','versions'].map(t=><div key={t} className={`tab${tab===t?' on':''}`} onClick={()=>sTab(t)} style={{textTransform:'capitalize'}}>{t}</div>)}</div>
    </div>
    <div className="modal-body">
      {tab==='edit'&&<>
        <div className="fg"><label className="fl">Title</label><input className="fi" value={title} onChange={e=>sT(e.target.value)} placeholder="Document title‚Ä¶"/></div>
        <div className="fg"><label className="fl">Content (Markdown)</label><textarea className="fi fta fi-mono" value={content} onChange={e=>sC(e.target.value)} placeholder="Write in markdown‚Ä¶" style={{minHeight:220}}/></div>
        <div className="fr2">
          <div className="fg"><label className="fl">Status</label>
            <select className="fi" value={status} onChange={e=>setSt(e.target.value)}>
              {['Todo','In Progress','In Review','Done'].map(s=><option key={s}>{s}</option>)}
            </select>
          </div>
          <div className="fg"><label className="fl">Folders</label>
            <div style={{display:'flex',flexWrap:'wrap',gap:5}}>
              {folders.map(f=><div key={f.id} onClick={()=>sFids(ids=>ids.includes(f.id)?ids.filter(i=>i!==f.id):[...ids,f.id])} style={{display:'inline-flex',alignItems:'center',gap:5,padding:'4px 10px',borderRadius:'var(--r)',border:'1px solid',cursor:'pointer',fontSize:12,background:fids.includes(f.id)?f.color+'22':'transparent',borderColor:fids.includes(f.id)?f.color:'var(--b0)',color:fids.includes(f.id)?f.color:'var(--t2)',transition:'all .1s'}}>
                {f.icon}{f.name}
              </div>)}
            </div>
          </div>
        </div>
        <div className="fg"><label className="fl">Tags</label><TagInput value={tags} onChange={sTags}/><div className="fhelp">Updates will trigger AI re-tagging (max 10 new tags)</div></div>
        {aiTagsList.length>0&&<div className="ai-panel"><div className="ai-label">‚ú¶ AI Generated Tags</div><div style={{display:'flex',flexWrap:'wrap',gap:4}}>{aiTagsList.map(t=><span key={t} className="tag tag-ai">{t}</span>)}</div>{doc.ai_summary&&<div style={{marginTop:8,fontSize:12,color:'var(--t1)',lineHeight:1.5,fontStyle:'italic'}}>"{doc.ai_summary}"</div>}</div>}
      </>}
      {tab==='preview'&&<div style={{fontFamily:'var(--mono)',fontSize:12,lineHeight:1.8,color:'var(--t1)',whiteSpace:'pre-wrap',padding:4}}>{content||<span style={{color:'var(--t3)',fontStyle:'italic'}}>Nothing to preview.</span>}</div>}
      {tab==='related'&&<div>{related.length?related.map(d=><div key={d.id} style={{background:'var(--s2)',border:'1px solid var(--b0)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:8,cursor:'pointer'}} onClick={()=>{onClose();}}><div style={{fontWeight:600,fontSize:13,marginBottom:4}}>{d.title}</div><div style={{display:'flex',gap:4,flexWrap:'wrap'}}>{[...(parseList(d.user_tags)),...(parseList(d.ai_tags))].slice(0,5).map(t=><span key={t} className="tag tag-user" style={{fontSize:10}}>{t}</span>)}</div></div>):<div className="empty"><div className="empty-ico">üîó</div><div className="empty-txt">No related documents</div><div className="empty-hint">Add matching tags to create connections</div></div>}</div>}
      {tab==='versions'&&<div>
        {versions.length===0?<div className="empty"><div className="empty-ico">üìú</div><div className="empty-txt">No version history yet</div><div className="empty-hint">Versions are saved automatically on each edit</div></div>
        :versions.map(v=><div key={v.version} style={{display:'flex',alignItems:'center',gap:12,padding:'10px 0',borderBottom:'1px solid var(--b0)'}}>
          <span style={{fontFamily:'var(--mono)',fontSize:12,color:'var(--t3)',minWidth:32}}>v{v.version}</span>
          <div style={{flex:1}}><div style={{fontSize:13,fontWeight:500}}>{v.title}</div><div style={{fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>{tAgo(v.changed_at)}</div></div>
          <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>{parseList(v.user_tags).slice(0,3).map(t=><span key={t} className="tag tag-user" style={{fontSize:10}}>{t}</span>)}</div>
        </div>)}
      </div>}
    </div>
    <div className="modal-foot">
      {doc?.id&&<button className="btn btn-danger btn-sm" onClick={()=>{onDelete(doc.id);onClose();}}>üóë Delete</button>}
      <button className="btn btn-ghost btn-sm" onClick={onClose}>Cancel</button>
      <button className="btn btn-primary btn-sm" onClick={save} disabled={saving||!title.trim()}>{saving?<><span className="spinner"/>&nbsp;Saving‚Ä¶</>:'Save'}</button>
    </div>
  </div></div>);
}

// ‚îÄ‚îÄ EXPORT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ExportModal({onClose,toast}){
  const[fmt,sF]=useState('zip-all');const[scope,sS]=useState('active');const[loading,sL]=useState(false);
  const opts=[
    {id:'zip-all',label:'Full ZIP Dump',desc:'All docs + files in one archive',icon:'üì¶'},
    {id:'zip-docs',label:'Documents ZIP',desc:'All documents as .md files',icon:'üìö'},
    {id:'zip-files',label:'Files ZIP',desc:'Raw uploaded files',icon:'üìÅ'},
    {id:'json',label:'JSON',desc:'Flat JSON array of documents',icon:'{ }'},
    {id:'csv',label:'CSV',desc:'Spreadsheet-compatible export',icon:'üìä'},
    {id:'markdown',label:'Markdown',desc:'Combined .md file',icon:'üìù'},
  ];
  const doExport=async()=>{
    sL(true);
    try{
      let url;
      if(fmt==='zip-all') url=`${getAPI()}/download/all.zip?scope=${scope}`;
      else if(fmt==='zip-docs') url=`${getAPI()}/download/docs.zip?scope=${scope}&format=markdown`;
      else if(fmt==='zip-files') url=`${getAPI()}/download/files.zip`;
      else url=`${getAPI()}/export?format=${fmt}&scope=${scope}`;
      const r=await fetch(url);
      if(!r.ok) throw new Error(r.statusText);
      const blob=await r.blob();
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`akrs-export-${fmt}.${fmt.startsWith('zip')?'zip':fmt==='json'?'json':fmt==='csv'?'csv':'md'}`;
      a.click();
      toast('Export downloaded','success');onClose();
    }catch(e){toast('Export failed: '+e.message,'error');}
    finally{sL(false);}
  };
  return(<div className="overlay"><div className="modal modal-sm fade-in" onClick={e=>e.stopPropagation()}>
    <div className="modal-head"><span className="modal-title">Export Data</span><button className="btn btn-ghost btn-sm" onClick={onClose}>‚úï</button></div>
    <div className="modal-body">
      <div className="fg"><label className="fl">Format</label>
        <div style={{display:'flex',flexDirection:'column',gap:6}}>
          {opts.map(o=><div key={o.id} onClick={()=>sF(o.id)} style={{display:'flex',alignItems:'center',gap:10,padding:'9px 12px',borderRadius:'var(--r)',border:`1px solid ${fmt===o.id?'var(--ac)':'var(--b0)'}`,cursor:'pointer',background:fmt===o.id?'var(--acd)':'var(--s2)',transition:'all .1s'}}>
            <span style={{fontSize:18,minWidth:24}}>{o.icon}</span>
            <div><div style={{fontSize:13,fontWeight:600,color:fmt===o.id?'var(--ac)':'var(--t0)'}}>{o.label}</div><div style={{fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>{o.desc}</div></div>
          </div>)}
        </div>
      </div>
      <div className="fg"><label className="fl">Scope</label>
        <div style={{display:'flex',gap:8}}>
          {['active','all'].map(s=><div key={s} onClick={()=>sS(s)} style={{flex:1,padding:'7px',textAlign:'center',borderRadius:'var(--r)',border:`1px solid ${scope===s?'var(--ac)':'var(--b0)'}`,cursor:'pointer',background:scope===s?'var(--acd)':'transparent',color:scope===s?'var(--ac)':'var(--t2)',fontSize:12,fontWeight:600,fontFamily:'var(--mono)',transition:'all .1s'}}>{s==='active'?'Active only':'All (incl. deleted)'}</div>)}
        </div>
      </div>
    </div>
    <div className="modal-foot">
      <button className="btn btn-ghost btn-sm" onClick={onClose}>Cancel</button>
      <button className="btn btn-primary" onClick={doExport} disabled={loading}>{loading?<><span className="spinner"/>&nbsp;Downloading‚Ä¶</>:'‚¨á Download'}</button>
    </div>
  </div></div>);
}

// ‚îÄ‚îÄ DASHBOARD PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function DashboardPage({docs,files,folders,onNav,storageConfig,onNewIngest}){
  const[health,setHealth]=useState(null);
  const active=docs.filter(d=>d.is_active);
  const pinned=docs.filter(d=>d.is_active&&d.pinned);
  const recent=[...active].sort((a,b)=>new Date(b.updated_at)-new Date(a.updated_at)).slice(0,4);
  const totalSt=files.reduce((s,f)=>s+(f.size_bytes||0),0);
  const done=active.filter(d=>d.status==='Done').length;
  const activeBackends=(storageConfig?.active_backends)||['local'];

  useEffect(()=>{
    fetch(getAPI().replace('/api/v1','')+'/health').then(r=>r.json()).then(setHealth).catch(()=>{});
  },[]);

  return(<div className="content fade-in">
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}>
      <div>
        <h1 style={{fontSize:24,fontWeight:800,letterSpacing:'-.03em',marginBottom:2}}>Knowledge Base</h1>
        <p style={{color:'var(--t2)',fontSize:13,fontFamily:'var(--mono)'}}>AKRS v4 ¬∑ {active.length} documents ¬∑ {files.length} files
          {health&&<span style={{marginLeft:8,color:health.status==='healthy'?'var(--gn)':'var(--or)'}}>¬∑ {health.status==='healthy'?'‚úì':'‚ö†'} {health.db_mode}</span>}
        </p>
      </div>
      <button className="btn btn-primary" onClick={onNewIngest}>+ New</button>
    </div>

    {/* Storage status bar */}
    <div style={{background:'var(--s1)',border:'1px solid var(--b0)',borderRadius:'var(--rl)',padding:'12px 16px',marginBottom:20,display:'flex',alignItems:'center',gap:12,flexWrap:'wrap'}}>
      <span style={{fontSize:12,fontWeight:700,fontFamily:'var(--mono)',color:'var(--t2)',letterSpacing:'.06em',textTransform:'uppercase'}}>Storage</span>
      {[{key:'local',label:'PC Local',icon:'üíæ'},{key:'github',label:'GitHub',icon:'üêô'},{key:'drive',label:'Drive',icon:'‚òÅÔ∏è'}].map(b=>{
        const on=activeBackends.includes(b.key);
        return(<div key={b.key} style={{display:'flex',alignItems:'center',gap:6,padding:'4px 10px',borderRadius:'var(--r)',border:'1px solid var(--b0)',background:on?'var(--gnd)':'var(--s2)',cursor:'pointer'}} onClick={()=>onNav('storage')}>
          <div className={`sdot${on?' on':' off'}`}/><span style={{fontSize:12,fontFamily:'var(--mono)',color:on?'var(--gn)':'var(--t3)',fontWeight:600}}>{b.icon} {b.label}</span>
        </div>);
      })}
      <span style={{marginLeft:'auto',fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)',cursor:'pointer'}} onClick={()=>onNav('storage')}>Configure ‚Üí</span>
    </div>

    {/* Stats */}
    <div className="grid-stats" style={{marginBottom:24}}>
      {[
        {val:active.length,label:'Documents',sub:`${docs.filter(d=>!d.is_active).length} archived`,cls:'c-ac'},
        {val:files.length,label:'Files',sub:fmtBytes(totalSt)+' total',cls:'c-gn'},
        {val:done,label:'Completed',sub:active.length?Math.round(done/active.length*100)+'% done':'0%',cls:'c-bl'},
        {val:pinned.length,label:'Pinned',sub:'Priority docs',cls:'c-pu'},
        {val:folders.length,label:'Folders',sub:'Organised',cls:'c-or'},
        {val:active.filter(d=>d.ai_processed_at||d.ai_summary).length,label:'AI Enriched',sub:'With summaries',cls:'c-cy'},
      ].map(s=><div key={s.label} className={`stat-card ${s.cls}`}><div className="stat-val">{s.val}</div><div className="stat-label">{s.label}</div><div className="stat-sub">{s.sub}</div></div>)}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'2fr 1fr',gap:16}}>
      <div>
        <div className="section-head"><span className="section-title">Recent Documents</span><button className="btn btn-ghost btn-xs" onClick={()=>onNav('docs')}>View all ‚Üí</button></div>
        <div style={{display:'flex',flexDirection:'column',gap:8}}>
          {recent.map(doc=>{
            const dF=folders.filter(f=>parseList(doc.folder_ids).includes(f.id));
            return(<div key={doc.id} className="doc-card" onClick={()=>onNav('docs',doc)}>
              <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:8,marginBottom:6}}>
                <div style={{fontWeight:600,fontSize:13,lineHeight:1.3}}>{doc.title}</div>
                <span className={`tag-status ${statusClass(doc.status)}`}>{doc.status}</span>
              </div>
              {doc.ai_summary&&<div style={{fontSize:11,color:'var(--t2)',lineHeight:1.4,marginBottom:8,fontStyle:'italic'}}>"{doc.ai_summary}"</div>}
              <div style={{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap'}}>
                {dF.slice(0,2).map(f=><span key={f.id} style={{fontSize:10,color:f.color,fontFamily:'var(--mono)'}}>{f.icon}{f.name}</span>)}
                {parseList(doc.user_tags).slice(0,3).map(t=><span key={t} className="tag tag-user" style={{fontSize:10}}>{t}</span>)}
                <span style={{marginLeft:'auto',fontSize:10,color:'var(--t3)',fontFamily:'var(--mono)'}}>{tAgo(doc.updated_at)}</span>
              </div>
            </div>);
          })}
          {recent.length===0&&<div className="empty" style={{padding:'30px 20px'}}><div className="empty-ico">üìö</div><div className="empty-txt">No documents yet</div><button className="btn btn-primary btn-sm" style={{marginTop:12}} onClick={onNewIngest}>Create first</button></div>}
        </div>
      </div>

      <div style={{display:'flex',flexDirection:'column',gap:14}}>
        <div>
          <div className="section-head"><span className="section-title">Pinned</span></div>
          {pinned.length?<div style={{display:'flex',flexDirection:'column',gap:6}}>{pinned.slice(0,4).map(d=><div key={d.id} style={{background:'var(--s2)',borderRadius:'var(--r)',padding:'8px 12px',cursor:'pointer',fontSize:13,fontWeight:500}} onClick={()=>onNav('docs',d)}>üìå {d.title}</div>)}</div>:<div style={{color:'var(--t3)',fontSize:12,fontFamily:'var(--mono)'}}>No pinned docs</div>}
        </div>
        <div>
          <div className="section-head"><span className="section-title">Folders</span><button className="btn btn-ghost btn-xs" onClick={()=>onNav('folders')}>Manage ‚Üí</button></div>
          <div style={{display:'flex',flexDirection:'column',gap:5}}>
            {folders.map(f=>{const cnt=docs.filter(d=>d.is_active&&parseList(d.folder_ids).includes(f.id)).length;return(<div key={f.id} style={{display:'flex',alignItems:'center',gap:8,padding:'7px 10px',borderRadius:'var(--r)',background:'var(--s2)',cursor:'pointer'}} onClick={()=>onNav('docs')}>
              <div style={{width:8,height:8,borderRadius:'50%',background:f.color,flexShrink:0}}/>
              <span style={{fontSize:13,flex:1}}>{f.icon} {f.name}</span>
              <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--t3)'}}>{cnt}</span>
            </div>);})}
          </div>
        </div>
      </div>
    </div>
  </div>);
}

// ‚îÄ‚îÄ SEARCH PAGE ‚Äî SSE streaming ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function SearchPage({docs,files,folders,toast}){
  const[q,sQ]=useState('');const[dbResults,sDbR]=useState([]);const[aiResults,sAiR]=useState([]);
  const[expTags,sET]=useState([]);const[streaming,setStreaming]=useState(false);
  const[aiDone,setAiDone]=useState(false);const[activeTab,sAT]=useState('all');
  const[hist,sHist]=useLS('akrs-hist',[]);const[saved,sSaved]=useLS('akrs-saved',[]);
  const esRef=useRef(null);const dq=useDebounce(q,320);

  useEffect(()=>{
    if(esRef.current){esRef.current.close();esRef.current=null;}
    sDbR([]);sAiR([]);sET([]);setAiDone(false);
    if(!dq.trim()){setStreaming(false);return;}
    setStreaming(true);
    const url=`${getAPI()}/search/stream?q=${encodeURIComponent(dq)}`;
    const es=new EventSource(url);
    esRef.current=es;
    es.addEventListener('db_results',e=>{
      const data=JSON.parse(e.data);
      sDbR(data.results||[]);
      if(dq.trim())sHist(h=>[dq,...h.filter(x=>x!==dq)].slice(0,8));
    });
    es.addEventListener('ai_results',e=>{
      const data=JSON.parse(e.data);
      sAiR(data.results||[]);sET(data.expanded_terms||[]);setAiDone(true);
    });
    es.addEventListener('done',()=>{setStreaming(false);setAiDone(true);es.close();esRef.current=null;});
    es.addEventListener('error',()=>{setStreaming(false);es.close();esRef.current=null;});
    return()=>{if(es.readyState!==2)es.close();};
  },[dq]);

  const allResults=useMemo(()=>{
    const dbIds=new Set(dbResults.map(r=>r.id));
    const unique=[...dbResults,...aiResults.filter(r=>!dbIds.has(r.id))];
    return unique.map(r=>({...r,_source:dbIds.has(r.id)?'db':'ai'}));
  },[dbResults,aiResults]);

  const shown=activeTab==='docs'?allResults.filter(r=>!r.file_type):activeTab==='files'?allResults.filter(r=>r.file_type):allResults;
  const saveSrch=()=>{if(!q.trim()||saved.find(s=>s.q===q))return;sSaved(s=>[{q,at:new Date().toISOString()},...s].slice(0,10));toast('Search saved','success');};

  return(<div className="content fade-in">
    <h1 style={{fontSize:20,fontWeight:800,letterSpacing:'-.02em',marginBottom:16}}>Search</h1>
    <div style={{position:'relative',marginBottom:16}}>
      <span style={{position:'absolute',left:12,top:'50%',transform:'translateY(-50%)',pointerEvents:'none',fontSize:14,color:'var(--t2)'}}>üîç</span>
      <input className="fi" style={{paddingLeft:38,paddingRight:100,fontSize:15}} value={q} onChange={e=>sQ(e.target.value)} placeholder="Search documents and files‚Ä¶" autoFocus/>
      {q&&<div style={{position:'absolute',right:8,top:'50%',transform:'translateY(-50%)',display:'flex',gap:5}}>
        {streaming&&<span className="spinner"/>}
        <button className="btn btn-ghost btn-xs" onClick={saveSrch}>Save</button>
        <button className="btn btn-ghost btn-xs" onClick={()=>sQ('')}>‚úï</button>
      </div>}
    </div>

    {/* SSE stream indicator */}
    {q&&streaming&&<div className="stream-bar"><div className="stream-dot"/><span>DB results loaded ‚Äî waiting for AI expansion</span></div>}
    {q&&aiDone&&expTags.length>0&&<div className="ai-panel" style={{marginBottom:14}}>
      <div className="ai-label">‚ú¶ AI Expanded Terms ({expTags.length})</div>
      <div style={{display:'flex',flexWrap:'wrap',gap:5}}>{expTags.map(t=><span key={t} className="tag tag-ai">{t}</span>)}</div>
    </div>}

    {!q&&<>
      {hist.length>0&&<div style={{marginBottom:20}}><div className="section-head"><span className="section-title">Recent Searches</span><button className="btn btn-ghost btn-xs" onClick={()=>sHist([])}>Clear</button></div><div style={{display:'flex',flexWrap:'wrap',gap:6}}>{hist.map(h=><span key={h} onClick={()=>sQ(h)} style={{padding:'4px 10px',borderRadius:'var(--r)',border:'1px solid var(--b0)',cursor:'pointer',fontSize:12,fontFamily:'var(--mono)',color:'var(--t2)',background:'var(--s2)'}}>‚ü≥ {h}</span>)}</div></div>}
      {saved.length>0&&<div><div className="section-head"><span className="section-title">Saved Searches</span><button className="btn btn-ghost btn-xs" onClick={()=>sSaved([])}>Clear</button></div><div style={{display:'flex',flexWrap:'wrap',gap:6}}>{saved.map(s=><span key={s.q} onClick={()=>sQ(s.q)} style={{padding:'4px 10px',borderRadius:'var(--r)',border:'1px solid var(--b0)',cursor:'pointer',fontSize:12,fontFamily:'var(--mono)',color:'var(--bl)',background:'var(--bld)'}}>‚òÖ {s.q}</span>)}</div></div>}
    </>}

    {q&&<>
      <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:14}}>
        <div className="tabs">{['all','docs','files'].map(t=><div key={t} className={`tab${activeTab===t?' on':''}`} onClick={()=>sAT(t)} style={{textTransform:'capitalize'}}>{t} ({t==='all'?allResults.length:t==='docs'?allResults.filter(r=>!r.file_type).length:allResults.filter(r=>r.file_type).length})</div>)}</div>
        <span style={{fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)',marginLeft:'auto'}}>{shown.length} results{aiResults.length>0?` (${aiResults.length} from AI)`:''}</span>
      </div>
      {shown.length===0&&!streaming&&<div className="empty"><div className="empty-ico">üîç</div><div className="empty-txt">No results for "{q}"</div><div className="empty-hint">Try different terms or wait for AI expansion</div></div>}
      <div style={{display:'flex',flexDirection:'column',gap:8}}>
        {shown.map(item=>{
          const isAi=item._source==='ai';
          if(item.file_type){return(<div key={item.id} style={{background:'var(--s1)',border:`1px solid ${isAi?'rgba(168,85,247,.2)':'var(--b0)'}`,borderRadius:'var(--rl)',padding:'12px 16px',display:'flex',gap:12,alignItems:'flex-start'}}>
            <span style={{fontSize:28}}>{fileIcon(item.file_type)}</span>
            <div style={{flex:1}}><div style={{fontWeight:600,fontSize:13,marginBottom:2}}>{item.name}</div><div style={{fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>{fmtBytes(item.size_bytes)} ¬∑ {item.file_type?.toUpperCase()}</div></div>
            {isAi&&<span className="tag tag-ai" style={{fontSize:9}}>‚ú¶ AI</span>}
          </div>);}
          const dF=folders.filter(f=>parseList(item.folder_ids).includes(f.id));
          return(<div key={item.id} className="doc-card" style={isAi?{borderColor:'rgba(168,85,247,.2)'}:{}}>
            <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:8,marginBottom:5}}>
              <div style={{fontWeight:600,fontSize:13}}>{item.title}</div>
              <div style={{display:'flex',gap:4,alignItems:'center',flexShrink:0}}>
                {isAi&&<span className="tag tag-ai" style={{fontSize:9}}>‚ú¶ AI</span>}
                <span className={`tag-status ${statusClass(item.status)}`}>{item.status}</span>
              </div>
            </div>
            {item.ai_summary&&<div style={{fontSize:11,color:'var(--t2)',lineHeight:1.5,marginBottom:6,fontStyle:'italic'}}>"{item.ai_summary}"</div>}
            <div style={{display:'flex',gap:5,flexWrap:'wrap',alignItems:'center'}}>
              {dF.map(f=><span key={f.id} style={{fontSize:10,color:f.color}}>{f.icon}{f.name}</span>)}
              {parseList(item.user_tags).slice(0,4).map(t=><span key={t} className="tag tag-user" style={{fontSize:10}}>{t}</span>)}
              {parseList(item.ai_tags).slice(0,2).map(t=><span key={t} className="tag tag-ai" style={{fontSize:10}}>{t}</span>)}
            </div>
          </div>);
        })}
      </div>
    </>}
  </div>);
}

// ‚îÄ‚îÄ DOCS PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function DocsPage({folders,docs,setDocs,toast,initialDoc}){
  const[modal,sM]=useState(initialDoc||null);
  const[view,sV]=useState('grid');const[ff,sFF]=useState(null);const[showDel,sSd]=useState(false);
  const[sel,sSel]=useState(new Set());const[kanban,sKan]=useState(false);
  const[filter,sFilter]=useState('all');const[loading,sLoading]=useState(false);

  // Load from API on mount
  useEffect(()=>{
    sLoading(true);
    apiFetch('/documents?limit=100').then(d=>{if(d.documents?.length)setDocs(d.documents);}).catch(()=>{}).finally(()=>sLoading(false));
  },[]);

  const filtered=useMemo(()=>docs.filter(d=>(showDel||d.is_active)&&(ff?parseList(d.folder_ids).includes(ff):true)&&(filter==='all'||d.status===filter||(filter==='pinned'&&d.pinned)||(filter==='bookmarked'&&d.bookmarked))),[docs,ff,showDel,filter]);

  const handleSave=async(data)=>{
    if(data.id){setDocs(ds=>ds.map(d=>d.id===data.id?{...d,...data}:d));}
    else{setDocs(ds=>[data,...ds]);}
  };

  const handleDel=async(id)=>{
    try{await apiDelete(`/documents/${id}`);setDocs(ds=>ds.map(d=>d.id===id?{...d,is_active:false,deleted_at:new Date().toISOString()}:d));toast('Moved to trash','warn');}catch(e){toast(e.message,'error');}
  };

  const togglePin=async(id,e)=>{e.stopPropagation();const doc=docs.find(d=>d.id===id);try{await apiPatch(`/documents/${id}`,{pinned:!doc?.pinned});setDocs(ds=>ds.map(d=>d.id===id?{...d,pinned:!d.pinned}:d));}catch(e){toast(e.message,'error');}};
  const toggleBk=async(id,e)=>{e.stopPropagation();const doc=docs.find(d=>d.id===id);try{await apiPatch(`/documents/${id}`,{bookmarked:!doc?.bookmarked});setDocs(ds=>ds.map(d=>d.id===id?{...d,bookmarked:!d.bookmarked}:d));}catch(e){toast(e.message,'error');}};

  const STATUSES=['Todo','In Progress','In Review','Done'];

  return(<div className="content fade-in">
    {modal!==null&&<DocModal doc={modal} folders={folders} docs={docs} onClose={()=>sM(null)} onSave={handleSave} onDelete={handleDel} toast={toast}/>}
    <div className="section-head" style={{marginBottom:16}}>
      <div style={{display:'flex',alignItems:'center',gap:10}}>
        <h1 style={{fontSize:20,fontWeight:800,letterSpacing:'-.02em'}}>Documents</h1>
        <span style={{fontFamily:'var(--mono)',fontSize:11,color:'var(--t3)',background:'var(--s2)',padding:'2px 7px',borderRadius:10}}>{loading?'‚Ä¶':filtered.length}</span>
      </div>
      <div style={{display:'flex',gap:6}}>
        <button className="btn btn-ghost btn-sm" onClick={()=>sKan(!kanban)}>{kanban?'‚äû Grid':'‚äü Board'}</button>
        <button className="btn btn-primary btn-sm" onClick={()=>sM({})}>+ New</button>
      </div>
    </div>

    <div style={{display:'flex',gap:8,marginBottom:14,flexWrap:'wrap',alignItems:'center'}}>
      <div className="tabs">
        {['all','pinned','bookmarked','Todo','In Progress','In Review','Done'].map(f=><div key={f} className={`tab${filter===f?' on':''}`} onClick={()=>sFilter(f)}>{f==='all'?'All':f}</div>)}
      </div>
      <select className="fi" style={{width:'auto',padding:'5px 10px',fontSize:12}} onChange={e=>sFF(e.target.value||null)}>
        <option value="">All folders</option>
        {folders.map(f=><option key={f.id} value={f.id}>{f.icon} {f.name}</option>)}
      </select>
      <label style={{display:'flex',alignItems:'center',gap:5,fontSize:12,color:'var(--t2)',cursor:'pointer'}}><input type="checkbox" checked={showDel} onChange={e=>sSd(e.target.checked)}/> Show deleted</label>
      <div style={{marginLeft:'auto',display:'flex',gap:4}}>
        {['grid','list'].map(v=><button key={v} className={`btn btn-ghost btn-xs`} onClick={()=>sV(v)} style={view===v?{borderColor:'var(--ac)',color:'var(--ac)'}:{}}>{v==='grid'?'‚äû':'‚ò∞'}</button>)}
      </div>
    </div>

    {kanban&&<div className="kanban">{STATUSES.map(st=>{const cols=filtered.filter(d=>d.status===st&&d.is_active);return(<div key={st} className="kbcol"><div className="kbh"><span>{st}</span><span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--t3)'}}>{cols.length}</span></div><div className="kbb">{cols.map(d=><div key={d.id} className="kb-card" onClick={()=>sM(d)}><div style={{fontWeight:600,fontSize:12,marginBottom:5}}>{d.title}</div><div style={{display:'flex',flexWrap:'wrap',gap:3}}>{parseList(d.user_tags).slice(0,3).map(t=><span key={t} className="tag tag-user" style={{fontSize:9}}>{t}</span>)}</div></div>)}<button className="btn btn-ghost btn-xs" style={{margin:4,width:'calc(100% - 8px)'}} onClick={()=>sM({status:st})}>+ Add</button></div></div>);})}</div>}

    {!kanban&&<>
      {filtered.length===0&&!loading&&<div className="empty"><div className="empty-ico">üìö</div><div className="empty-txt">No documents</div><div className="empty-hint">Create your first document</div></div>}
      {loading&&<div style={{display:'flex',justifyContent:'center',padding:40}}><span className="spinner"/></div>}
      <div className={view==='grid'?'grid-docs':'list-view'}>
        {filtered.map(doc=>{
          const dF=folders.filter(f=>parseList(doc.folder_ids).includes(f.id));
          const isSel=sel.has(doc.id);
          return(<div key={doc.id} className={`doc-card${doc.is_active?'':' tombstone'}${isSel?' selected':''}${doc.pinned?' pinned':''}`} onClick={()=>sel.size>0?sSel(s=>{const n=new Set(s);n.has(doc.id)?n.delete(doc.id):n.add(doc.id);return n;}):sM(doc)}>
            <div style={{display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:6,marginBottom:6}}>
              <input type="checkbox" checked={isSel} onChange={()=>{}} onClick={e=>{e.stopPropagation();sSel(s=>{const n=new Set(s);n.has(doc.id)?n.delete(doc.id):n.add(doc.id);return n;});}} style={{marginTop:2,accentColor:'var(--ac)',flexShrink:0}}/>
              <div style={{flex:1,fontWeight:600,fontSize:13,lineHeight:1.3}}>{doc.title}</div>
              <span className={`tag-status ${statusClass(doc.status)}`}>{doc.status}</span>
            </div>
            {doc.ai_summary&&<div style={{fontSize:11,color:'var(--t2)',lineHeight:1.4,marginBottom:7,fontStyle:'italic',paddingLeft:20}}>"{doc.ai_summary}"</div>}
            <div style={{display:'flex',gap:5,flexWrap:'wrap',alignItems:'center',paddingLeft:20,marginBottom:5}}>
              {dF.slice(0,2).map(f=><span key={f.id} style={{fontSize:10,color:f.color,fontFamily:'var(--mono)'}}>{f.icon}{f.name}</span>)}
              {parseList(doc.user_tags).slice(0,3).map(t=><span key={t} className="tag tag-user" style={{fontSize:10}}>{t}</span>)}
              {parseList(doc.ai_tags).slice(0,1).map(t=><span key={t} className="tag tag-ai" style={{fontSize:10}}>{t}</span>)}
            </div>
            <div style={{display:'flex',alignItems:'center',gap:8,paddingLeft:20}}>
              <span style={{marginLeft:'auto',fontFamily:'var(--mono)',fontSize:10,color:'var(--t3)'}}>{tAgo(doc.updated_at)} ¬∑ v{doc.version||1}</span>
              <button className={`btn btn-xs${doc.pinned?'':' btn-ghost'}`} onClick={e=>togglePin(doc.id,e)} style={doc.pinned?{background:'var(--ord)',color:'var(--or)',border:'1px solid rgba(249,115,22,.2)'}:{}} title="Pin">üìå</button>
              <button className={`btn btn-xs${doc.bookmarked?'':' btn-ghost'}`} onClick={e=>toggleBk(doc.id,e)} style={doc.bookmarked?{background:'var(--bld)',color:'var(--bl)',border:'1px solid rgba(59,130,246,.2)'}:{}} title="Bookmark">üîñ</button>
            </div>
          </div>);
        })}
      </div>
    </>}

    {sel.size>0&&<div className="sel-bar">
      <span style={{fontFamily:'var(--mono)',fontSize:12}}>{sel.size} selected</span>
      <button className="btn btn-ghost btn-sm" onClick={async()=>{try{await apiPost('/bulk/documents',{ids:[...sel],action:'pin'});setDocs(ds=>ds.map(d=>sel.has(d.id)?{...d,pinned:true}:d));toast(sel.size+' pinned','success');sSel(new Set());}catch(e){toast(e.message,'error');}}}>üìå Pin all</button>
      <button className="btn btn-danger btn-sm" onClick={async()=>{try{await apiPost('/bulk/documents',{ids:[...sel],action:'delete'});setDocs(ds=>ds.map(d=>sel.has(d.id)?{...d,is_active:false}:d));toast(sel.size+' deleted','warn');sSel(new Set());}catch(e){toast(e.message,'error');}}}>üóë Delete</button>
      <button className="btn btn-ghost btn-xs" onClick={()=>sSel(new Set())}>‚úï</button>
    </div>}
  </div>);
}

// ‚îÄ‚îÄ FILES PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function FilesPage({files,setFiles,folders,toast,storageConfig}){
  const[dragging,sDrag]=useState(false);const[sel,sSel]=useState(new Set());
  const[view,sV]=useState('grid');const[filter,sFilter]=useState('');
  const[uploading,sUploading]=useState(false);const[loading,sLoading]=useState(false);
  const ref=useRef();
  const activeBackends=(storageConfig?.active_backends)||['local'];

  useEffect(()=>{
    sLoading(true);
    apiFetch('/files?limit=200').then(d=>{if(d.files?.length)setFiles(d.files);}).catch(()=>{}).finally(()=>sLoading(false));
  },[]);

  const handleDrop=async e=>{
    e.preventDefault();sDrag(false);
    const dropped=[...(e.dataTransfer?.files||e.target?.files||[])];
    if(!dropped.length)return;
    sUploading(true);
    try{
      const results=[];
      for(const f of dropped){
        const fd=new FormData();
        fd.append('file',f);
        const r=await fetch(getAPI()+'/ingest',{method:'POST',body:fd});
        if(r.ok){const d=await r.json();results.push(d);}
      }
      setFiles(fs=>[...results,...fs]);
      toast(`Uploaded ${results.length} file(s) ‚Üí ${activeBackends.join(' + ')}`,'success');
    }catch(e){toast('Upload failed: '+e.message,'error');}
    finally{sUploading(false);}
  };

  const filtered=files.filter(f=>!filter||f.name?.toLowerCase().includes(filter.toLowerCase())||(f.tags||[]).some(t=>t.includes(filter)));
  const totalBytes=files.reduce((s,f)=>s+(f.size_bytes||0),0);

  const deleteFile=async id=>{
    try{await apiDelete(`/files/${id}`);setFiles(fs=>fs.filter(f=>f.id!==id));toast('File deleted','warn');}
    catch(e){toast(e.message,'error');}
  };

  const downloadFile=id=>{
    const a=document.createElement('a');a.href=`${getAPI()}/files/${id}/download`;a.click();
  };

  return(<div className="content fade-in">
    <div className="section-head" style={{marginBottom:14}}>
      <div style={{display:'flex',alignItems:'center',gap:10}}>
        <h1 style={{fontSize:20,fontWeight:800,letterSpacing:'-.02em'}}>Files</h1>
        <span style={{fontFamily:'var(--mono)',fontSize:11,color:'var(--t3)',background:'var(--s2)',padding:'2px 7px',borderRadius:10}}>{files.length} ¬∑ {fmtBytes(totalBytes)}</span>
      </div>
      <div style={{display:'flex',gap:4}}>
        {['grid','list'].map(v=><button key={v} className="btn btn-ghost btn-xs" onClick={()=>sV(v)} style={view===v?{borderColor:'var(--ac)',color:'var(--ac)'}:{}}>{v==='grid'?'‚äû':'‚ò∞'}</button>)}
        <button className="btn btn-primary btn-sm" onClick={()=>ref.current?.click()}>‚¨Ü Upload</button>
        <input ref={ref} type="file" multiple style={{display:'none'}} onChange={e=>handleDrop({dataTransfer:{files:[...e.target.files]}})}/>
      </div>
    </div>

    {/* Storage info */}
    <div style={{background:'var(--s1)',border:'1px solid var(--b0)',borderRadius:'var(--r)',padding:'8px 14px',marginBottom:14,display:'flex',alignItems:'center',gap:8,fontSize:12,fontFamily:'var(--mono)',color:'var(--t2)'}}>
      <span>üì¶ Saves to:</span>
      {activeBackends.includes('local')&&<span className="store-badge sb-local">üíæ Local PC</span>}
      {activeBackends.includes('github')&&<span className="store-badge sb-github">üêô GitHub</span>}
      {activeBackends.includes('drive')&&<span className="store-badge sb-drive">‚òÅÔ∏è Drive</span>}
      {activeBackends.length===0&&<span style={{color:'var(--rd)'}}>‚ö† No backends enabled</span>}
    </div>

    {/* Filter */}
    <div style={{position:'relative',marginBottom:14}}>
      <span style={{position:'absolute',left:10,top:'50%',transform:'translateY(-50%)',pointerEvents:'none',color:'var(--t3)'}}>üîç</span>
      <input className="fi" style={{paddingLeft:34}} value={filter} onChange={e=>sFilter(e.target.value)} placeholder="Filter by name or tag‚Ä¶"/>
    </div>

    {/* Dropzone */}
    <div className={`dropzone${dragging?' over':''}`} style={{marginBottom:16}}
      onDragOver={e=>{e.preventDefault();sDrag(true);}}
      onDragLeave={()=>sDrag(false)}
      onDrop={handleDrop}
      onClick={()=>ref.current?.click()}>
      {uploading
        ?<><div className="spinner" style={{margin:'0 auto 10px'}}/><div className="dz-text">Uploading‚Ä¶</div></>
        :<><div className="dz-icon">üìÇ</div><div className="dz-text">Drop files here or click to upload</div><div className="dz-hint">Saves to: {activeBackends.join(' + ')||'no backend'} ¬∑ max 100 MB per file</div></>}
    </div>

    {/* Files grid/list */}
    {loading&&<div style={{display:'flex',justifyContent:'center',padding:40}}><span className="spinner"/></div>}
    {!loading&&filtered.length===0&&<div className="empty"><div className="empty-ico">üìÅ</div><div className="empty-txt">No files</div><div className="empty-hint">Upload files to index and search them</div></div>}
    {!loading&&filtered.length>0&&<div className={view==='grid'?'grid-files':'list-view'}>
      {filtered.map(f=>{
        const isSel=sel.has(f.id);
        const ftype=f.file_type||(f.name||'').split('.').pop()||'bin';
        if(view==='list')return(
          <div key={f.id} style={{background:'var(--s1)',border:'1px solid var(--b0)',borderRadius:'var(--r)',padding:'10px 14px',display:'flex',alignItems:'center',gap:12}}>
            <input type="checkbox" checked={isSel} onChange={()=>sSel(s=>{const n=new Set(s);n.has(f.id)?n.delete(f.id):n.add(f.id);return n;})} style={{accentColor:'var(--ac)'}}/>
            <span style={{fontSize:22}}>{fileIcon(ftype)}</span>
            <div style={{flex:1}}>
              <div style={{fontSize:13,fontWeight:600}}>{f.name}</div>
              <div style={{fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>{fmtBytes(f.size_bytes)} ¬∑ {ftype.toUpperCase()} ¬∑ {tAgo(f.uploaded_at)}</div>
            </div>
            {f.storage_locations&&<StorageBadges locations={f.storage_locations}/>}
            <div style={{display:'flex',gap:4}}>
              <button className="btn btn-ghost btn-xs" onClick={()=>downloadFile(f.id)}>‚¨á</button>
              <button className="btn btn-danger btn-xs" onClick={()=>deleteFile(f.id)}>üóë</button>
            </div>
          </div>
        );
        return(
          <div key={f.id} className={`file-card${isSel?' selected':''}`} onClick={()=>sSel(s=>{const n=new Set(s);n.has(f.id)?n.delete(f.id):n.add(f.id);return n;})}>
            <div className="file-icon" style={{color:fileColor(ftype)}}>{fileIcon(ftype)}</div>
            <div className="file-name">{f.name}</div>
            <div className="file-size">{fmtBytes(f.size_bytes)}</div>
            <div className="file-type-badge" style={{background:fileColor(ftype)+'22',color:fileColor(ftype)}}>{ftype.toUpperCase()}</div>
            {f.storage_locations&&<StorageBadges locations={f.storage_locations}/>}
          </div>
        );
      })}
    </div>}

    {sel.size>0&&<div className="sel-bar">
      <span style={{fontFamily:'var(--mono)',fontSize:12}}>{sel.size} selected</span>
      <button className="btn btn-ghost btn-sm" onClick={()=>{sel.forEach(id=>downloadFile(id));toast('Downloading‚Ä¶','info');}}>‚¨á Download</button>
      <button className="btn btn-danger btn-sm" onClick={async()=>{for(const id of sel)await deleteFile(id);sSel(new Set());}}>üóë Delete</button>
      <button className="btn btn-ghost btn-xs" onClick={()=>sSel(new Set())}>‚úï</button>
    </div>}
  </div>);
}

// ‚îÄ‚îÄ FOLDER TREE NODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function FolderTreeNode({node,docs,files,onSelect,selectedId,onMove,level=0}){
  const[open,sOpen]=useState(true);
  const hasChildren=node.children?.length>0;
  const docCount=docs.filter(d=>d.is_active&&parseList(d.folder_ids).includes(node.id)).length;
  const fileCount=files.filter(f=>parseList(f.folder_ids||[]).includes(node.id)).length;
  const isSelected=selectedId===node.id;
  return(<div className="folder-node">
    <div className={`folder-row${isSelected?' on':''}`} onClick={()=>onSelect(node)}>
      <div style={{width:level*12,flexShrink:0}}/>
      <div className="folder-toggle" onClick={e=>{e.stopPropagation();if(hasChildren)sOpen(o=>!o);}} style={{opacity:hasChildren?1:0,transform:open?'rotate(90deg)':'none'}}>‚ñ∂</div>
      <span style={{fontSize:16}}>{node.icon||'üìÅ'}</span>
      <span style={{flex:1,fontSize:13,fontWeight:isSelected?600:400,color:isSelected?node.color:'var(--t1)'}}>{node.name}</span>
      <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--t3)'}}>{docCount+fileCount}</span>
    </div>
    {hasChildren&&open&&<div className="folder-children">
      {node.children.map(ch=><FolderTreeNode key={ch.id} node={ch} docs={docs} files={files} onSelect={onSelect} selectedId={selectedId} level={level+1}/>)}
    </div>}
  </div>);
}

// ‚îÄ‚îÄ FOLDERS PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function FoldersPage({folders,setFolders,docs,files,toast}){
  const[modal,sM]=useState(null);
  const[name,sName]=useState('');const[color,sColor]=useState('#3b82f6');const[icon,sIcon]=useState('üìÅ');
  const[parentId,sParentId]=useState('');const[selected,sSelected]=useState(null);
  const[folderContents,sFolderContents]=useState(null);const[loadingContents,sLoadingContents]=useState(false);
  const[view,sView]=useState('cards'); // 'cards' | 'tree'

  useEffect(()=>{
    apiFetch('/folders').then(d=>{if(d.folders?.length)setFolders(d.folders);}).catch(()=>{});
  },[]);

  // Build nested tree from flat list
  const buildTree=useCallback(flat=>{
    const map={};flat.forEach(f=>{map[f.id]={...f,children:[]};});
    const roots=[];
    flat.forEach(f=>{
      if(f.parent_id&&map[f.parent_id])map[f.parent_id].children.push(map[f.id]);
      else roots.push(map[f.id]);
    });
    return roots;
  },[]);
  const tree=useMemo(()=>buildTree(folders),[folders,buildTree]);

  const saveFolder=async()=>{
    if(!name.trim())return;
    try{
      const body={name,slug:name.toLowerCase().replace(/\s+/g,'-'),color,icon,parent_id:parentId||null};
      const d=await apiPost('/folders',body);
      setFolders(fs=>[...fs,d]);
      sM(null);sName('');toast('Folder created','success');
    }catch(e){toast(e.message,'error');}
  };

  const deleteFolder=async(id)=>{
    try{
      await apiDelete(`/folders/${id}?cascade=false`);
      setFolders(fs=>fs.filter(f=>f.id!==id));
      if(selected?.id===id)sSelected(null);
      toast('Folder deleted','warn');
    }catch(e){toast(e.message,'error');}
  };

  const selectFolder=async f=>{
    sSelected(f);
    sLoadingContents(true);
    try{
      const d=await apiFetch(`/folders/${f.id}/contents`);
      sFolderContents(d);
    }catch(e){sFolderContents(null);}
    finally{sLoadingContents(false);}
  };

  const icons=['üìÅ','‚öôÔ∏è','üîê','‚ö°','üöÄ','üèóÔ∏è','üìö','üî¨','üé®','üí°','üåê','üîß','üìä','üóÑÔ∏è','üß™','üéØ','üì°','üîë'];
  const colors=['#3b82f6','#22c55e','#ef4444','#f59e0b','#8b5cf6','#06b6d4','#ec4899','#f97316'];

  return(<div className="content fade-in">
    {modal&&<div className="overlay"><div className="modal modal-sm fade-in" onClick={e=>e.stopPropagation()}>
      <div className="modal-head"><span className="modal-title">New Folder</span><button className="btn btn-ghost btn-sm" onClick={()=>sM(null)}>‚úï</button></div>
      <div className="modal-body">
        <div className="fg"><label className="fl">Name</label><input className="fi" value={name} onChange={e=>sName(e.target.value)} placeholder="Folder name‚Ä¶" autoFocus/></div>
        <div className="fg"><label className="fl">Parent Folder (optional)</label>
          <select className="fi" value={parentId} onChange={e=>sParentId(e.target.value)}>
            <option value="">‚Äî Root level ‚Äî</option>
            {folders.map(f=><option key={f.id} value={f.id}>{f.icon} {f.name}</option>)}
          </select>
          <div className="fhelp">Leave empty to create at root. Nested folders supported.</div>
        </div>
        <div className="fg"><label className="fl">Icon</label>
          <div style={{display:'flex',flexWrap:'wrap',gap:6}}>
            {icons.map(ic=><div key={ic} onClick={()=>sIcon(ic)} style={{width:36,height:36,display:'flex',alignItems:'center',justifyContent:'center',borderRadius:'var(--r)',border:`2px solid ${icon===ic?'var(--ac)':'var(--b0)'}`,cursor:'pointer',fontSize:18,background:icon===ic?'var(--acd)':'var(--s2)'}}>{ic}</div>)}
          </div>
        </div>
        <div className="fg"><label className="fl">Color</label>
          <div style={{display:'flex',gap:6}}>
            {colors.map(c=><div key={c} onClick={()=>sColor(c)} style={{width:26,height:26,borderRadius:4,background:c,cursor:'pointer',border:`2px solid ${color===c?'var(--t0)':'transparent'}`,transition:'border .1s'}}/>)}
          </div>
        </div>
      </div>
      <div className="modal-foot">
        <button className="btn btn-ghost btn-sm" onClick={()=>sM(null)}>Cancel</button>
        <button className="btn btn-primary btn-sm" onClick={saveFolder} disabled={!name.trim()}>Create</button>
      </div>
    </div></div>}

    <div className="section-head" style={{marginBottom:16}}>
      <div style={{display:'flex',alignItems:'center',gap:10}}>
        <h1 style={{fontSize:20,fontWeight:800,letterSpacing:'-.02em'}}>Folders</h1>
        <span style={{fontFamily:'var(--mono)',fontSize:11,color:'var(--t3)',background:'var(--s2)',padding:'2px 7px',borderRadius:10}}>{folders.length}</span>
      </div>
      <div style={{display:'flex',gap:6}}>
        {['cards','tree'].map(v=><button key={v} className="btn btn-ghost btn-sm" onClick={()=>sView(v)} style={view===v?{borderColor:'var(--ac)',color:'var(--ac)'}:{}}>{v==='tree'?'üå≤ Tree':'‚äû Cards'}</button>)}
        <button className="btn btn-primary btn-sm" onClick={()=>sM(true)}>+ New Folder</button>
      </div>
    </div>

    {view==='tree'&&<div style={{display:'grid',gridTemplateColumns:'260px 1fr',gap:16}}>
      {/* Tree panel */}
      <div className="card" style={{padding:0,overflow:'hidden'}}>
        <div style={{padding:'10px 12px',borderBottom:'1px solid var(--b0)',fontFamily:'var(--mono)',fontSize:10,fontWeight:700,letterSpacing:'.1em',textTransform:'uppercase',color:'var(--t3)'}}>Folder Tree</div>
        <div style={{padding:8}}>
          {tree.map(node=><FolderTreeNode key={node.id} node={node} docs={docs} files={files} onSelect={selectFolder} selectedId={selected?.id}/>)}
          {folders.length===0&&<div style={{padding:'20px 8px',color:'var(--t3)',fontSize:12,fontFamily:'var(--mono)',textAlign:'center'}}>No folders yet</div>}
        </div>
      </div>

      {/* Contents panel */}
      <div>
        {selected?<>
          <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:14}}>
            <span style={{fontSize:24}}>{selected.icon}</span>
            <div><div style={{fontWeight:700,fontSize:16,color:selected.color}}>{selected.name}</div><div style={{fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>/{selected.slug}</div></div>
            <button className="btn btn-danger btn-sm" style={{marginLeft:'auto'}} onClick={()=>deleteFolder(selected.id)}>üóë Delete</button>
          </div>
          {loadingContents?<div style={{display:'flex',justifyContent:'center',padding:40}}><span className="spinner"/></div>
          :folderContents?<>
            {folderContents.items?.length===0&&<div className="empty"><div className="empty-ico">üì≠</div><div className="empty-txt">Empty folder</div></div>}
            <div style={{display:'flex',flexDirection:'column',gap:6}}>
              {(folderContents.items||[]).map(item=><div key={item.id} style={{background:'var(--s1)',border:'1px solid var(--b0)',borderRadius:'var(--r)',padding:'10px 14px',display:'flex',alignItems:'center',gap:10}}>
                <span style={{fontSize:18}}>{item.file_type?fileIcon(item.file_type):'üìÑ'}</span>
                <div style={{flex:1}}><div style={{fontSize:13,fontWeight:600}}>{item.title||item.name}</div><div style={{fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>{item.file_type?fmtBytes(item.size_bytes):item.status} ¬∑ {tAgo(item.updated_at||item.uploaded_at)}</div></div>
              </div>)}
            </div>
          </>:<div className="empty"><div className="empty-ico">‚ö†Ô∏è</div><div className="empty-txt">Could not load contents</div></div>}
        </>:<div className="empty"><div className="empty-ico">üëà</div><div className="empty-txt">Select a folder</div><div className="empty-hint">Click a folder in the tree to view its contents</div></div>}
      </div>
    </div>}

    {view==='cards'&&<div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:12}}>
      {folders.map(f=>{
        const dc=docs.filter(d=>d.is_active&&parseList(d.folder_ids).includes(f.id)).length;
        const fc=files.filter(fi=>parseList(fi.folder_ids||[]).includes(f.id)).length;
        const parentFolder=folders.find(p=>p.id===f.parent_id);
        return(<div key={f.id} style={{background:'var(--s1)',border:`1px solid ${f.color}44`,borderRadius:'var(--rl)',padding:'16px',cursor:'pointer',transition:'all .15s',position:'relative'}}
          onMouseEnter={e=>e.currentTarget.style.borderColor=f.color}
          onMouseLeave={e=>e.currentTarget.style.borderColor=f.color+'44'}
          onClick={()=>{sView('tree');selectFolder(f);}}>
          {parentFolder&&<div style={{fontSize:10,color:'var(--t3)',fontFamily:'var(--mono)',marginBottom:4}}>‚Ü≥ {parentFolder.name}</div>}
          <div style={{fontSize:28,marginBottom:8}}>{f.icon}</div>
          <div style={{fontWeight:700,fontSize:14,color:f.color,marginBottom:2}}>{f.name}</div>
          <div style={{fontFamily:'var(--mono)',fontSize:11,color:'var(--t3)'}}>{dc} docs ¬∑ {fc} files</div>
          <div style={{height:3,background:f.color+'22',borderRadius:2,marginTop:10,overflow:'hidden'}}>
            <div style={{height:'100%',width:`${Math.min((dc+fc)*10,100)}%`,background:f.color,borderRadius:2}}/>
          </div>
          <button className="btn btn-danger btn-xs" style={{position:'absolute',top:8,right:8,opacity:0}} onClick={e=>{e.stopPropagation();deleteFolder(f.id);}}
            onMouseEnter={e=>e.currentTarget.style.opacity=1} onMouseLeave={e=>e.currentTarget.style.opacity=0}>üóë</button>
        </div>);
      })}
      <div style={{background:'var(--s2)',border:'2px dashed var(--b1)',borderRadius:'var(--rl)',padding:'16px',cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:6,minHeight:120,color:'var(--t3)',transition:'all .15s'}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor='var(--ac)';e.currentTarget.style.color='var(--ac)';}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor='var(--b1)';e.currentTarget.style.color='var(--t3)';}}
        onClick={()=>sM(true)}>
        <span style={{fontSize:28,opacity:.4}}>+</span>
        <span style={{fontSize:12,fontWeight:600}}>New Folder</span>
      </div>
    </div>}
  </div>);
}

// ‚îÄ‚îÄ ANALYTICS PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function AnalyticsPage({docs,files}){
  const[data,setData]=useState(null);const[loading,setLoading]=useState(true);

  useEffect(()=>{
    setLoading(true);
    apiFetch('/analytics').then(setData).catch(()=>{
      // Compute from local state if API fails
      const active=docs.filter(d=>d.is_active);
      const aiDone=active.filter(d=>d.ai_processed_at||d.ai_summary).length;
      setData({
        documents:{total:active.length,tombstoned:docs.filter(d=>!d.is_active).length,ai_processed:aiDone,ai_coverage_pct:active.length?Math.round(aiDone/active.length*100):0,pinned:active.filter(d=>d.pinned).length,bookmarked:active.filter(d=>d.bookmarked).length,by_status:['Todo','In Progress','In Review','Done'].map(s=>({status:s,count:active.filter(d=>d.status===s).length}))},
        files:{total:files.length,total_bytes:files.reduce((s,f)=>s+(f.size_bytes||0),0),by_type:Object.entries(files.reduce((a,f)=>{a[f.file_type]=(a[f.file_type]||0)+(f.size_bytes||0);return a;},{})).map(([t,b])=>({file_type:t,bytes:b,count:files.filter(f=>f.file_type===t).length}))},
        search:{top_queries:[]},
        ai_queue:{by_status:[]},
        versions:{total_snapshots:0},
        folders:[],
      });
    }).finally(()=>setLoading(false));
  },[docs,files]);

  if(loading)return(<div className="content fade-in" style={{display:'flex',justifyContent:'center',paddingTop:60}}><span className="spinner"/></div>);
  if(!data)return null;

  const statusColors={'Todo':'var(--t3)','In Progress':'var(--bl)','In Review':'var(--or)','Done':'var(--gn)'};
  const maxByStatus=Math.max(1,...(data.documents.by_status||[]).map(s=>s.count));

  return(<div className="content fade-in">
    <h1 style={{fontSize:20,fontWeight:800,letterSpacing:'-.02em',marginBottom:20}}>Analytics</h1>

    {/* Key stats */}
    <div className="grid-stats" style={{marginBottom:24}}>
      {[
        {val:data.documents.total,label:'Active Docs',sub:`${data.documents.tombstoned} archived`,cls:'c-ac'},
        {val:data.files.total,label:'Files',sub:fmtBytes(data.files.total_bytes),cls:'c-gn'},
        {val:data.documents.ai_coverage_pct+'%',label:'AI Coverage',sub:`${data.documents.ai_processed} enriched`,cls:'c-pu'},
        {val:data.documents.pinned,label:'Pinned',sub:`${data.documents.bookmarked} bookmarked`,cls:'c-bl'},
        {val:data.versions?.total_snapshots||0,label:'Versions Saved',sub:'All time',cls:'c-or'},
        {val:(data.ai_queue?.by_status||[]).find(s=>s.status==='pending')?.count||0,label:'AI Queue',sub:'Pending processing',cls:'c-cy'},
      ].map(s=><div key={s.label} className={`stat-card ${s.cls}`}><div className="stat-val">{s.val}</div><div className="stat-label">{s.label}</div><div className="stat-sub">{s.sub}</div></div>)}
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:16}}>
      {/* Status breakdown */}
      <div className="card">
        <div className="section-title" style={{marginBottom:14}}>Document Status</div>
        {(data.documents.by_status||[]).map(s=>{
          const pct=Math.round(s.count/maxByStatus*100);
          return(<div key={s.status} style={{marginBottom:10}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:12,marginBottom:4}}>
              <span style={{color:statusColors[s.status]||'var(--t1)',fontWeight:500}}>{s.status}</span>
              <span style={{fontFamily:'var(--mono)',color:'var(--t3)'}}>{s.count}</span>
            </div>
            <div className="prog-bar">
              <div className="prog-fill" style={{width:`${Math.max(pct,2)}%`,background:statusColors[s.status]||'var(--ac)'}}/>
            </div>
          </div>);
        })}
      </div>

      {/* AI pipeline */}
      <div className="card">
        <div className="section-title" style={{marginBottom:14}}>AI Pipeline</div>
        <div style={{display:'flex',alignItems:'center',gap:16,marginBottom:16}}>
          <div style={{flex:1}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:12,marginBottom:4}}>
              <span style={{color:'var(--pu)'}}>AI Enriched</span>
              <span style={{fontFamily:'var(--mono)',color:'var(--t2)'}}>{data.documents.ai_processed} / {data.documents.total}</span>
            </div>
            <div className="prog-bar" style={{height:8}}><div className="prog-fill" style={{width:`${data.documents.ai_coverage_pct}%`,background:'var(--pu)'}}/></div>
          </div>
          <div style={{fontFamily:'var(--mono)',fontSize:28,fontWeight:500,color:'var(--pu)'}}>{data.documents.ai_coverage_pct}%</div>
        </div>
        {(data.ai_queue?.by_status||[]).length>0&&<>
          <div style={{fontSize:12,color:'var(--t2)',marginBottom:8,fontWeight:500}}>Queue Status</div>
          {data.ai_queue.by_status.map(s=><div key={s.status} style={{display:'flex',justifyContent:'space-between',fontSize:12,padding:'4px 0',borderBottom:'1px solid var(--b0)'}}>
            <span style={{fontFamily:'var(--mono)',color:'var(--t2)'}}>{s.status}</span>
            <span style={{fontFamily:'var(--mono)',color:'var(--t3)'}}>{s.count}</span>
          </div>)}
        </>}
        {(data.ai_queue?.by_status||[]).length===0&&<div style={{fontSize:12,color:'var(--t3)',fontFamily:'var(--mono)'}}>Queue empty ‚Äî all docs processed</div>}
      </div>
    </div>

    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
      {/* File types */}
      <div className="card">
        <div className="section-title" style={{marginBottom:14}}>Files by Type</div>
        {(data.files.by_type||[]).slice(0,8).map(t=>{
          const pct=data.files.total_bytes?Math.round((t.bytes||0)/data.files.total_bytes*100):0;
          return(<div key={t.file_type} style={{marginBottom:8}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:12,marginBottom:3}}>
              <span style={{color:fileColor(t.file_type),fontFamily:'var(--mono)',fontWeight:500}}>{fileIcon(t.file_type)} {(t.file_type||'?').toUpperCase()}</span>
              <span style={{color:'var(--t3)',fontFamily:'var(--mono)'}}>{fmtBytes(t.bytes||0)}</span>
            </div>
            <div className="prog-bar"><div className="prog-fill" style={{width:`${Math.max(pct,2)}%`,background:fileColor(t.file_type)}}/></div>
          </div>);
        })}
        {(data.files.by_type||[]).length===0&&<div style={{color:'var(--t3)',fontSize:12,fontFamily:'var(--mono)'}}>No files uploaded</div>}
      </div>

      {/* Top searches */}
      <div className="card">
        <div className="section-title" style={{marginBottom:14}}>Top Searches</div>
        {(data.search?.top_queries||[]).length===0&&<div style={{color:'var(--t3)',fontSize:12,fontFamily:'var(--mono)'}}>No search data yet</div>}
        {(data.search?.top_queries||[]).slice(0,8).map((s,i)=><div key={s.query} style={{display:'flex',alignItems:'center',gap:10,padding:'6px 0',borderBottom:'1px solid var(--b0)'}}>
          <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--t3)',minWidth:18,textAlign:'right'}}>{i+1}</span>
          <span style={{flex:1,fontFamily:'var(--mono)',fontSize:12}}>{s.query}</span>
          <span style={{fontFamily:'var(--mono)',fontSize:11,color:'var(--t3)',background:'var(--s3)',padding:'1px 6px',borderRadius:10}}>{s.count}√ó</span>
        </div>)}
      </div>
    </div>
  </div>);
}

// ‚îÄ‚îÄ STORAGE PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function StoragePage({storageConfig,setStorageConfig,toast,docs,files}){
  const[cfg,setCfg]=useState(storageConfig||DEMO_STORAGE);
  const[testing,sTesting]=useState({});const[migrating,sMig]=useState(false);
  const[tab,sTab]=useState('backends');
  const[diskUsage]=useState({free_gb:127.4,total_gb:256,used_gb:128.6});

  useEffect(()=>{
    apiFetch('/storage/config').then(d=>{setCfg(d);setStorageConfig(d);}).catch(()=>{});
  },[]);

  const toggle=async backend=>{
    const cur=cfg.config[backend].enabled;
    const newActive=Object.entries({...cfg.config,[backend]:{...cfg.config[backend],enabled:!cur}}).filter(([,v])=>v.enabled).map(([k])=>k);
    if(newActive.length===0){toast('Cannot disable all backends ‚Äî keep at least one','warn');return;}
    try{
      const d=await apiPost('/storage/config',{[backend]:{enabled:!cur}});
      setCfg(d);setStorageConfig(d);
      toast(`${backend} storage ${!cur?'enabled':'disabled'}`,'success');
    }catch(e){toast(e.message,'error');}
  };

  const testBackend=async b=>{
    sTesting(t=>({...t,[b]:true}));
    try{
      const d=await apiFetch('/storage/status');
      const ok=d[b]?.connected;
      toast(`${b}: ${ok?'Connected ‚úì':'Not reachable ‚Äî check credentials'}`,ok?'success':'warn');
    }catch(e){toast('Status check failed','error');}
    finally{sTesting(t=>({...t,[b]:false}));}
  };

  const migrate=async()=>{
    sMig(true);
    try{await apiPost('/storage/migrate',{});toast('Migration complete','success');}
    catch(e){toast(e.message,'error');}
    finally{sMig(false);}
  };

  const backends=[
    {key:'local',icon:'üíæ',name:'Local PC',color:'#22c55e',bgColor:'rgba(34,197,94,.08)',desc:"Stores files on your computer's filesystem. Zero cost, works offline, fastest access.",detail:`Path: ${cfg.config?.local?.base_dir||'./data/files'}`,cost:'Free'},
    {key:'github',icon:'üêô',name:'GitHub Repository',color:'#e4e4e7',bgColor:'rgba(255,255,255,.04)',desc:'Commits uploaded files to a GitHub repo. Free for public repos. Files are Git-versioned.',detail:cfg.config?.github?.repo?`Repo: ${cfg.config.github.repo} (${cfg.config.github.branch||'main'}) ‚Üí ${cfg.config.github.path||'uploads'}/`:'Not configured ‚Äî add GITHUB_TOKEN and GITHUB_REPO to .env',cost:'Free (public)'},
    {key:'drive',icon:'‚òÅÔ∏è',name:'Google Drive',color:'#3b82f6',bgColor:'rgba(59,130,246,.07)',desc:'Uploads to Google Drive via service account. Free up to 15 GB.',detail:cfg.config?.drive?.folder_id?`Folder ID: ${cfg.config.drive.folder_id}`:'Not configured ‚Äî add GOOGLE_DRIVE_CREDENTIALS to .env',cost:'Free up to 15 GB'},
  ];
  const localPct=Math.round((diskUsage.used_gb/diskUsage.total_gb)*100);

  return(<div className="content fade-in">
    <div className="section-head" style={{marginBottom:6}}>
      <div><h1 style={{fontSize:20,fontWeight:800,letterSpacing:'-.02em'}}>Storage</h1><p style={{fontSize:12,color:'var(--t2)',fontFamily:'var(--mono)',marginTop:2}}>Files save to all enabled backends simultaneously</p></div>
      <button className="btn btn-ghost btn-sm" onClick={migrate} disabled={migrating}>{migrating?<><span className="spinner"/>Migrating‚Ä¶</>:'üîÑ Migrate All'}</button>
    </div>

    <div style={{marginBottom:16}}>
      <div className="tabs">{['backends','usage','settings'].map(t=><div key={t} className={`tab${tab===t?' on':''}`} onClick={()=>sTab(t)} style={{textTransform:'capitalize'}}>{t}</div>)}</div>
    </div>

    {tab==='backends'&&<>
      <div style={{background:'var(--s1)',border:'1px solid var(--b0)',borderRadius:'var(--rl)',padding:'12px 16px',marginBottom:14,display:'flex',alignItems:'center',gap:10,flexWrap:'wrap'}}>
        <span style={{fontSize:11,fontWeight:700,fontFamily:'var(--mono)',color:'var(--t3)',letterSpacing:'.08em',textTransform:'uppercase'}}>Active:</span>
        {(cfg.active_backends||[]).length===0?<span style={{color:'var(--rd)',fontFamily:'var(--mono)',fontSize:12}}>‚ö† None ‚Äî data not saved externally</span>:(cfg.active_backends||[]).map(b=>{const ba=backends.find(x=>x.key===b);return(<span key={b} style={{display:'inline-flex',alignItems:'center',gap:5,padding:'3px 10px',borderRadius:'var(--r)',background:ba?.bgColor,border:`1px solid ${ba?.color}44`,fontFamily:'var(--mono)',fontSize:11,fontWeight:600,color:ba?.color}}><div className="sdot on"/>{ba?.icon} {ba?.name}</span>);})}
        <span style={{marginLeft:'auto',fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>Cost: {(cfg.cost_estimate?.notes||[]).join(' ¬∑ ')||'‚Äî'}</span>
      </div>

      <div className="storage-panel">
        {backends.map(b=>{const on=cfg.config?.[b.key]?.enabled;return(<div key={b.key} className="storage-backend" style={{background:on?b.bgColor:'transparent'}}>
          <div className="sb-icon" style={{background:b.bgColor,border:`1px solid ${b.color}33`}}>{b.icon}</div>
          <div className="sb-info">
            <div className="sb-name">
              <span style={{color:on?b.color:'var(--t1)'}}>{b.name}</span>
              {on&&<span style={{fontFamily:'var(--mono)',fontSize:9,padding:'1px 6px',borderRadius:4,background:`${b.color}22`,color:b.color,fontWeight:500}}>ACTIVE</span>}
              <span style={{fontFamily:'var(--mono)',fontSize:10,color:'var(--t3)',marginLeft:4}}>{b.cost}</span>
            </div>
            <div className="sb-desc">{b.desc}</div>
            <div className="sb-meta" style={{color:on?b.color+'88':'var(--t3)'}}>{b.detail}</div>
            {on&&<div style={{marginTop:6}}>
              <button className="btn btn-ghost btn-xs" onClick={()=>testBackend(b.key)} disabled={testing[b.key]}>{testing[b.key]?<><span className="spinner"/>Testing‚Ä¶</>:'Test Connection'}</button>
            </div>}
          </div>
          <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:6}}>
            <div className={`toggle${on?' on':''}`} onClick={()=>toggle(b.key)}/>
            <span style={{fontFamily:'var(--mono)',fontSize:10,color:on?'var(--gn)':'var(--t3)'}}>{on?'ON':'OFF'}</span>
          </div>
        </div>);})}
      </div>

      <div style={{marginTop:12,padding:'10px 14px',background:'var(--s1)',border:'1px solid var(--b0)',borderRadius:'var(--r)',fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)',lineHeight:1.7}}>
        üí° <strong style={{color:'var(--t2)'}}>Fan-out writes:</strong> Files are written to all active backends simultaneously on upload. Downloads try Local first (fastest), then GitHub, then Drive. Use "Migrate All" to push existing files to newly-enabled backends.
      </div>
    </>}

    {tab==='usage'&&<>
      <div className="grid-stats" style={{marginBottom:16}}>
        <div className="stat-card c-ac"><div className="stat-val">{docs.filter(d=>d.is_active).length}</div><div className="stat-label">Documents</div></div>
        <div className="stat-card c-gn"><div className="stat-val">{files.length}</div><div className="stat-label">Files</div><div className="stat-sub">{fmtBytes(files.reduce((s,f)=>s+(f.size_bytes||0),0))}</div></div>
        <div className="stat-card c-bl"><div className="stat-val">{diskUsage.free_gb.toFixed(1)} GB</div><div className="stat-label">Local Free</div><div className="stat-sub">of {diskUsage.total_gb} GB total</div></div>
        <div className="stat-card c-or"><div className="stat-val">{(cfg.active_backends||[]).length}</div><div className="stat-label">Active Backends</div></div>
      </div>
      <div className="card" style={{marginBottom:12}}>
        <div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}>
          <span style={{fontSize:13,fontWeight:600}}>üíæ Local Disk</span>
          <span style={{fontFamily:'var(--mono)',fontSize:12,color:'var(--t2)'}}>{diskUsage.used_gb.toFixed(1)} / {diskUsage.total_gb} GB ({localPct}%)</span>
        </div>
        <div className="prog-bar" style={{height:8,marginBottom:6}}><div className="prog-fill" style={{width:`${localPct}%`,background:localPct>80?'var(--rd)':localPct>60?'var(--or)':'var(--ac)'}}/></div>
        <div style={{fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>{diskUsage.free_gb.toFixed(1)} GB free ¬∑ AKRS files: {fmtBytes(files.reduce((s,f)=>s+(f.size_bytes||0),0))}</div>
      </div>
      <div className="card">
        <div style={{fontSize:13,fontWeight:600,marginBottom:12}}>Storage per file type</div>
        {Object.entries(files.reduce((acc,f)=>{acc[f.file_type||'bin']=(acc[f.file_type||'bin']||0)+(f.size_bytes||0);return acc;},{})).sort(([,a],[,b])=>b-a).map(([type,bytes])=>{
          const total=Math.max(1,files.reduce((s,f)=>s+(f.size_bytes||0),0));
          const pct=Math.round(bytes/total*100);
          return(<div key={type} style={{marginBottom:8}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:12,marginBottom:4}}>
              <span style={{color:fileColor(type),fontFamily:'var(--mono)',fontWeight:500}}>{fileIcon(type)} {type.toUpperCase()}</span>
              <span style={{color:'var(--t3)',fontFamily:'var(--mono)'}}>{fmtBytes(bytes)}</span>
            </div>
            <div className="prog-bar"><div className="prog-fill" style={{width:`${Math.max(pct,2)}%`,background:fileColor(type)}}/></div>
          </div>);
        })}
      </div>
    </>}

    {tab==='settings'&&<>
      <div className="card" style={{marginBottom:12}}>
        <div style={{fontFamily:'var(--mono)',fontSize:11,fontWeight:700,letterSpacing:'.08em',textTransform:'uppercase',color:'var(--t2)',marginBottom:12}}>Local Storage</div>
        <div className="fg"><label className="fl">Storage Directory</label>
          <input className="fi fi-mono" value={cfg.config?.local?.base_dir||'./data/files'} onChange={e=>setCfg(c=>({...c,config:{...c.config,local:{...c.config.local,base_dir:e.target.value}}}))}/>
          <div className="fhelp">Files saved to this path on your PC</div>
        </div>
      </div>
      <div className="card" style={{marginBottom:12}}>
        <div style={{fontFamily:'var(--mono)',fontSize:11,fontWeight:700,letterSpacing:'.08em',textTransform:'uppercase',color:'var(--t2)',marginBottom:12}}>GitHub</div>
        <div className="fr2">
          <div className="fg"><label className="fl">Repository (owner/repo)</label><input className="fi fi-mono" value={cfg.config?.github?.repo||''} onChange={e=>setCfg(c=>({...c,config:{...c.config,github:{...c.config.github,repo:e.target.value}}}))} placeholder="org/knowledge-base"/></div>
          <div className="fg"><label className="fl">Branch</label><input className="fi fi-mono" value={cfg.config?.github?.branch||'main'} onChange={e=>setCfg(c=>({...c,config:{...c.config,github:{...c.config.github,branch:e.target.value}}}))} /></div>
        </div>
        <div className="fg"><label className="fl">Upload Path</label><input className="fi fi-mono" value={cfg.config?.github?.path||'uploads'} onChange={e=>setCfg(c=>({...c,config:{...c.config,github:{...c.config.github,path:e.target.value}}}))} /></div>
        <div style={{background:'var(--s2)',borderRadius:'var(--r)',padding:'8px 12px',fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>Set GITHUB_TOKEN in .env ‚Äî requires "repo" scope for private repos</div>
      </div>
      <div className="card" style={{marginBottom:12}}>
        <div style={{fontFamily:'var(--mono)',fontSize:11,fontWeight:700,letterSpacing:'.08em',textTransform:'uppercase',color:'var(--t2)',marginBottom:12}}>Google Drive</div>
        <div className="fg"><label className="fl">Drive Folder ID</label><input className="fi fi-mono" value={cfg.config?.drive?.folder_id||''} onChange={e=>setCfg(c=>({...c,config:{...c.config,drive:{...c.config.drive,folder_id:e.target.value}}}))} placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms"/></div>
        <div style={{background:'var(--s2)',borderRadius:'var(--r)',padding:'8px 12px',fontSize:11,color:'var(--t3)',fontFamily:'var(--mono)'}}>Set GOOGLE_DRIVE_CREDENTIALS to your service account JSON path in .env</div>
      </div>
      <button className="btn btn-primary" onClick={async()=>{try{await apiPost('/storage/config',cfg.config||{});toast('Storage settings saved','success');}catch(e){toast(e.message,'error');}}}>Save Storage Settings</button>
    </>}
  </div>);
}

// ‚îÄ‚îÄ SETTINGS PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function SettingsPage({theme,setTheme,apiBase,setApiBase,toast}){
  const[url,sUrl]=useState(apiBase);const[testing,sTesting]=useState(false);const[status,setStatus]=useState(null);
  const[schema,setSchema]=useState(null);const[runtimeVals,setRuntimeVals]=useState({});const[saving,setSaving]=useState(false);

  // Load settings schema & current values from API
  useEffect(()=>{
    apiFetch('/settings/schema').then(setSchema).catch(()=>{});
    apiFetch('/settings').then(d=>setRuntimeVals(d.settings||{})).catch(()=>{});
  },[]);

  const testBackend=async()=>{
    sTesting(true);
    try{const r=await fetch(url.replace('/api/v1','')+'/health');const d=await r.json();setStatus(d);toast(`Backend: ${d.status} (${d.db_mode})`,'success');}
    catch(e){setStatus(null);toast('Cannot reach backend: '+e.message,'error');}
    finally{sTesting(false);}
  };

  const saveRuntimeSettings=async()=>{
    setSaving(true);
    try{await apiPost('/settings',{updates:runtimeVals,persist_to_env_file:false});toast('Settings applied (runtime only)','success');}
    catch(e){toast(e.message,'error');}
    finally{setSaving(false);}
  };

  const saveToEnv=async()=>{
    setSaving(true);
    try{await apiPost('/settings',{updates:runtimeVals,persist_to_env_file:true});toast('Settings saved to .env file','success');}
    catch(e){toast(e.message,'error');}
    finally{setSaving(false);}
  };

  // API returns {schema: {"AI":[...fields], "Storage":[...fields]}} ‚Äî already grouped by key
  // If somehow it comes back as a flat array, convert it too
  const groupedSchema=useMemo(()=>{
    if(!schema?.schema) return {};
    const s = schema.schema;
    // Already a dict of group‚Üífields (normal API shape)
    if(!Array.isArray(s)) return s;
    // Flat array fallback: group by field.group or field.category
    return s.reduce((acc,field)=>{
      const cat = field.group || field.category || 'Other';
      (acc[cat]=acc[cat]||[]).push(field);
      return acc;
    },{});
  },[schema]);

  return(<div className="content fade-in" style={{maxWidth:720}}>
    <h1 style={{fontSize:20,fontWeight:800,letterSpacing:'-.02em',marginBottom:20}}>Settings</h1>

    {/* Appearance */}
    <div className="set-group">
      <div className="set-group-head">Appearance</div>
      <div className="set-row">
        <div><div className="set-lbl">Dark Mode</div><div className="set-desc">Toggle light/dark theme</div></div>
        <div className={`toggle${theme==='dark'?' on':''}`} onClick={()=>setTheme(theme==='dark'?'light':'dark')}/>
      </div>
    </div>

    {/* Backend connection */}
    <div className="set-group">
      <div className="set-group-head">Backend Connection</div>
      <div style={{padding:'12px 16px'}}>
        <div className="fg"><label className="fl">API Base URL</label>
          <div style={{display:'flex',gap:8}}>
            <input className="fi fi-mono" value={url} onChange={e=>sUrl(e.target.value)} placeholder="http://localhost:8000/api/v1" style={{flex:1}}/>
            <button className="btn btn-ghost btn-sm" onClick={testBackend} disabled={testing}>{testing?<><span className="spinner"/>‚Ä¶</>:'Test'}</button>
            <button className="btn btn-primary btn-sm" onClick={()=>{setApiBase(url);API_BASE=url;toast('API URL saved','success');}}>Save</button>
          </div>
          <div className="fhelp">Default: http://localhost:8000/api/v1 ¬∑ Run python start.py to start the backend</div>
        </div>
        {status&&<div style={{background:'var(--gnd)',border:'1px solid rgba(34,197,94,.2)',borderRadius:'var(--r)',padding:'10px 14px',fontSize:12,fontFamily:'var(--mono)',color:'var(--gn)',lineHeight:1.7}}>
          ‚úì Connected ¬∑ DB: {status.db_mode} ¬∑ AI: {status.ai_provider} ¬∑ Storage: {(status.storage_backends||[]).join(', ')||'‚Äî'}
        </div>}
      </div>
    </div>

    {/* Runtime settings from schema */}
    {Object.entries(groupedSchema).map(([category,fields])=><div key={category} className="set-group">
      <div className="set-group-head">{category}</div>
      <div style={{padding:'0 16px'}}>
        {fields.map(f=>{
          const val=runtimeVals[f.key]!==undefined?runtimeVals[f.key]:f.default;
          return(<div key={f.key} className="set-row">
            <div style={{flex:1,marginRight:16}}>
              <div className="set-lbl">{f.label}</div>
              <div className="set-desc">{f.description}</div>
            </div>
            {f.type==='boolean'&&<div className={`toggle${val?' on':''}`} onClick={()=>setRuntimeVals(v=>({...v,[f.key]:!val}))}/>}
            {f.type==='integer'&&<input className="fi fi-mono" type="number" value={val||''} onChange={e=>setRuntimeVals(v=>({...v,[f.key]:parseInt(e.target.value)||0}))} style={{width:100,textAlign:'right'}}/>}
            {(f.type==='string'||f.type==='path')&&<input className="fi fi-mono" value={val||''} onChange={e=>setRuntimeVals(v=>({...v,[f.key]:e.target.value}))} style={{width:220}} placeholder={f.placeholder||''}/>}
            {f.type==='secret'&&<input className="fi fi-mono" type="password" value={val||''} onChange={e=>setRuntimeVals(v=>({...v,[f.key]:e.target.value}))} style={{width:220}} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>}
            {f.type==='select'&&<select className="fi" value={val||''} onChange={e=>setRuntimeVals(v=>({...v,[f.key]:e.target.value}))} style={{width:160}}>
              {(f.options||[]).map(o=><option key={o}>{o}</option>)}
            </select>}
          </div>);
        })}
      </div>
    </div>)}

    {Object.keys(groupedSchema).length>0&&<div style={{display:'flex',gap:8,marginBottom:20}}>
      <button className="btn btn-ghost" onClick={saveRuntimeSettings} disabled={saving}>{saving?<><span className="spinner"/>‚Ä¶</>:'Apply (runtime only)'}</button>
      <button className="btn btn-primary" onClick={saveToEnv} disabled={saving}>{saving?<><span className="spinner"/>‚Ä¶</>:'Save to .env'}</button>
      <button className="btn btn-ghost btn-sm" onClick={()=>apiPost('/settings/reload',{}).then(()=>toast('Settings reloaded from .env','success')).catch(e=>toast(e.message,'error'))}>üîÑ Reload .env</button>
    </div>}

    {/* Quick start */}
    <div className="set-group">
      <div className="set-group-head">Quick Start</div>
      <div style={{padding:'12px 16px'}}>
        {[
          {label:'Run on PC (SQLite + local storage)',cmd:'python start.py'},
          {label:'Run with hot-reload',cmd:'python start.py --reload'},
          {label:'Reset database',cmd:'python start.py --reset'},
          {label:'Custom port',cmd:'python start.py --port 9000'},
          {label:'Docker (PostgreSQL + Nginx)',cmd:'docker-compose up -d'},
        ].map(({label,cmd})=><div key={cmd} style={{marginBottom:8}}>
          <div style={{fontSize:11,color:'var(--t2)',marginBottom:2}}>{label}</div>
          <div style={{background:'var(--s2)',borderRadius:'var(--r)',padding:'7px 12px',fontFamily:'var(--mono)',fontSize:12,color:'var(--ac)',display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer'}} onClick={()=>{navigator.clipboard?.writeText(cmd);toast('Copied!','success');}}>$ {cmd}<span style={{fontSize:10,color:'var(--t3)'}}>copy</span></div>
        </div>)}
      </div>
    </div>

    {/* About */}
    <div className="set-group">
      <div className="set-group-head">About</div>
      <div style={{padding:'12px 16px',fontFamily:'var(--mono)',fontSize:12,color:'var(--t2)',lineHeight:1.8}}>
        <div>AKRS <strong style={{color:'var(--ac)'}}>v4</strong></div>
        <div>Storage: LOCAL ¬∑ GITHUB ¬∑ DRIVE</div>
        <div>Database: SQLite (PC) / PostgreSQL (prod)</div>
        <div>AI: Anthropic Claude / OpenAI GPT / Static</div>
        <div style={{marginTop:6,color:'var(--t3)'}}>New in v4: Unified ingest ¬∑ SSE streaming search ¬∑ Nested folders ¬∑ Settings API ¬∑ Smart AI tagging</div>
      </div>
    </div>
  </div>);
}

// ‚îÄ‚îÄ ROOT APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App(){
  const[page,sPage]=useState('dashboard');const[pageData,sPageData]=useState(null);
  const[docs,setDocs]=useState(DEMO_DOCS);const[files,setFiles]=useState(DEMO_FILES);
  const[folders,setFolders]=useState(DEMO_FOLDERS);
  const[storageConfig,setStorageConfig]=useState(DEMO_STORAGE);
  const[theme,setTheme]=useLS('akrs-theme','dark');
  const[apiBase,setApiBase]=useLS('akrs-api','http://localhost:8000/api/v1');
  const[cmd,sCmd]=useState(false);const[sidebar,sSidebar]=useState(true);
  const[exportOpen,sExport]=useState(false);const[ingestOpen,sIngest]=useState(false);
  const{toasts,toast}=useToast();

  useEffect(()=>{document.documentElement.setAttribute('data-theme',theme);},[theme]);
  useEffect(()=>{API_BASE=apiBase;},[apiBase]);
  useEffect(()=>{const hk=e=>{if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();sCmd(c=>!c);}if(e.key==='Escape'){sCmd(false);}};document.addEventListener('keydown',hk);return()=>document.removeEventListener('keydown',hk);},[]);

  // Load folders + storage config on boot
  useEffect(()=>{
    apiFetch('/folders').then(d=>{if(d.folders?.length)setFolders(d.folders);}).catch(()=>{});
    apiFetch('/storage/config').then(d=>{if(d.config)setStorageConfig(d);}).catch(()=>{});
  },[]);

  const nav=(pg,data=null)=>{sPage(pg);sPageData(data);};

  const pages=[
    {id:'dashboard',icon:'‚åÇ',label:'Dashboard'},
    {id:'search',icon:'‚åï',label:'Search'},
    {id:'docs',icon:'‚óß',label:'Documents'},
    {id:'files',icon:'‚ñ£',label:'Files'},
    {id:'folders',icon:'‚óà',label:'Folders'},
    {id:'analytics',icon:'‚Üó',label:'Analytics'},
    null,
    {id:'storage',icon:'‚äû',label:'Storage'},
    {id:'settings',icon:'‚óâ',label:'Settings'},
  ];

  const fDocs=useMemo(()=>docs.filter(d=>d.is_active&&parseList(d.folder_ids).length>0).reduce((acc,d)=>{parseList(d.folder_ids).forEach(fid=>{acc[fid]=(acc[fid]||0)+1;});return acc;},{}),[docs]);

  const handleIngestDone=data=>{
    if(data._type==='file'||data.file_type){setFiles(fs=>[data,...fs]);}
    else{setDocs(ds=>[data,...ds]);}
  };

  return(<div className="shell">
    <div className="toast-container">{toasts.map(t=><div key={t.id} className={`toast ${t.type}`}>{t.type==='success'?'‚úì':t.type==='error'?'‚úó':t.type==='warn'?'‚ö†':'‚Ñπ'} {t.msg}</div>)}</div>

    {cmd&&<CmdPalette onClose={()=>sCmd(false)} onNav={nav} docs={docs}/>}
    {exportOpen&&<ExportModal onClose={()=>sExport(false)} toast={toast}/>}
    {ingestOpen&&<IngestModal folders={folders} onClose={()=>sIngest(false)} onDone={handleIngestDone} toast={toast} storageConfig={storageConfig}/>}

    {/* Icon rail */}
    <div className="rail">
      <div className="rail-logo" onClick={()=>sPage('dashboard')} title="AKRS v4">v4</div>
      {pages.map((p,i)=>p===null
        ?<div key={i} className="rail-sep"/>
        :<div key={p.id} className={`ri${page===p.id?' on':''}`} onClick={()=>nav(p.id)}>
          {p.icon}<span className="tip">{p.label}</span>
        </div>
      )}
      <div style={{flex:1}}/>
      <div className="ri" onClick={()=>sIngest(true)} title="New document or file">‚úö<span className="tip">New (Ingest)</span></div>
      <div className="ri" onClick={()=>sCmd(true)} title="Command palette (‚åòK)">‚åò<span className="tip">‚åòK Palette</span></div>
    </div>

    {/* Sidebar */}
    <div className={`sidebar${sidebar?'':' collapsed'}`}>
      <div className="sb-head" style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <span className="sb-title">AKRS v4</span>
        <button className="btn btn-ghost btn-xs" onClick={()=>sSidebar(false)} style={{padding:'2px 5px',fontSize:14}}>‚Äπ</button>
      </div>
      <div className="sb-list">
        {pages.filter(Boolean).map(p=><div key={p.id} className={`sbi${page===p.id?' on':''}`} onClick={()=>nav(p.id)}>
          <span style={{fontSize:15,minWidth:18,textAlign:'center'}}>{p.icon}</span>
          <span>{p.label}</span>
        </div>)}

        <div className="sb-sec">Folders</div>
        {folders.filter(f=>!f.parent_id).map(f=><div key={f.id} className="sbi" onClick={()=>nav('folders')}>
          <div className="fdot" style={{background:f.color}}/>
          <span style={{flex:1,fontSize:12}}>{f.icon} {f.name}</span>
          <span className="badge">{fDocs[f.id]||0}</span>
        </div>)}

        <div style={{height:8}}/>
        <div className="sbi" onClick={()=>sIngest(true)}><span style={{fontSize:15,minWidth:18,textAlign:'center'}}>‚úö</span>New Document / File</div>
        <div className="sbi" onClick={()=>sExport(true)}><span style={{fontSize:15,minWidth:18,textAlign:'center'}}>‚¨á</span>Export Data</div>
      </div>

      {/* Storage mini-indicator */}
      <div style={{padding:'10px 12px',borderTop:'1px solid var(--b0)'}}>
        <div style={{fontSize:9,fontFamily:'var(--mono)',fontWeight:700,letterSpacing:'.1em',textTransform:'uppercase',color:'var(--t3)',marginBottom:5}}>Storage</div>
        <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
          {[{k:'local',ico:'üíæ'},{k:'github',ico:'üêô'},{k:'drive',ico:'‚òÅÔ∏è'}].map(b=>{
            const on=(storageConfig.active_backends||[]).includes(b.k);
            return(<div key={b.k} style={{display:'flex',alignItems:'center',gap:3,padding:'2px 6px',borderRadius:3,background:on?'var(--gnd)':'var(--s3)',cursor:'pointer'}} onClick={()=>nav('storage')}>
              <div className={`sdot${on?' on':' off'}`}/>
              <span style={{fontSize:10,fontFamily:'var(--mono)',color:on?'var(--gn)':'var(--t3)'}}>{b.ico}</span>
            </div>);
          })}
        </div>
      </div>
    </div>

    {/* Expand sidebar button */}
    {!sidebar&&<div style={{position:'absolute',left:56,top:0,zIndex:30,height:'100%',display:'flex',alignItems:'flex-start',paddingTop:12}}>
      <button className="btn btn-ghost btn-xs" onClick={()=>sSidebar(true)} style={{borderRadius:'0 4px 4px 0',padding:'4px 5px',fontSize:13,background:'var(--s1)',borderLeft:'none'}}>‚Ä∫</button>
    </div>}

    {/* Main area */}
    <div className="main">
      {page==='dashboard'&&<DashboardPage docs={docs} files={files} folders={folders} onNav={nav} storageConfig={storageConfig} onNewIngest={()=>sIngest(true)}/>}
      {page==='search'&&<SearchPage docs={docs} files={files} folders={folders} toast={toast}/>}
      {page==='docs'&&<DocsPage folders={folders} docs={docs} setDocs={setDocs} toast={toast} initialDoc={pageData}/>}
      {page==='files'&&<FilesPage files={files} setFiles={setFiles} folders={folders} toast={toast} storageConfig={storageConfig}/>}
      {page==='folders'&&<FoldersPage folders={folders} setFolders={setFolders} docs={docs} files={files} toast={toast}/>}
      {page==='analytics'&&<AnalyticsPage docs={docs} files={files}/>}
      {page==='storage'&&<StoragePage storageConfig={storageConfig} setStorageConfig={setStorageConfig} toast={toast} docs={docs} files={files}/>}
      {page==='settings'&&<SettingsPage theme={theme} setTheme={setTheme} apiBase={apiBase} setApiBase={setApiBase} toast={toast}/>}
    </div>
  </div>);
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
